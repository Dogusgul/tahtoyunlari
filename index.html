<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taht Sava≈ülarƒ±</title>
    <style>
        html {
            scroll-behavior: smooth; /* Sayfa kaydƒ±rmalarƒ±nƒ± yumu≈üatƒ±r */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            transition: background-color 0.5s ease;
        }

        /* --- BA≈ûLANGI√á MEN√úS√ú --- */
        #start-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('arka-plan.png');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            width: 728px;
            height: auto;
            border: 2px solid #555;
        }

        #start-menu h1 {
            font-size: 2.5em;
            margin-top: 10px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px #000;
            letter-spacing: 2px;
            color: #fff;
        }

        #start-menu input {
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #888;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            width: 60%;
            max-width: 300px;
            text-align: center;
            color: #333;
        }

        #start-menu button {
            padding: 12px 35px;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(145deg, #65c365, #4caf50);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #start-menu button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        /* --- OYUN ARY√úZ√ú --- */
        #game-window {
            display: none;
            width: 90%;
            max-width: 1200px;
            background-color: #ffffff;
            border: 1px solid #d1d1d1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 8px;
        }

        #map-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 120px);
            gap: 6px;
            background-color: #d8e0e8;
            border: 1px solid #b0c4de;
            margin-bottom: 20px;
            padding: 6px;
            border-radius: 6px;
            position: relative; 
        }

        .map-region {
            border: 1px solid #777;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
            position: relative; 
            overflow: hidden; 
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        .map-region.selected-region {
            border: 3px solid #ffeb3b;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
            transform: scale(1.02);
        }
        .map-region:hover:not(.selected-region) {
            transform: scale(1.03);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .map-region .region-name {
            background-color: rgba(0,0,0,0.65);
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.8em;
            text-shadow: 1px 1px 2px #000;
        }
        .map-region .region-owner {
            font-size: 0.7em;
            color: #f0f0f0;
            margin-top: 4px;
            background-color: rgba(0,0,0,0.5);
            padding: 2px 4px;
            border-radius: 2px;
            text-shadow: 1px 1px 1px #000;
        }
         .map-region .rebellion-text {
            color: #ffc107 !important;
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            background: rgba(211, 47, 47, 0.85) !important;
            font-size: 0.75em !important;
            padding: 2px 5px !important;
            border-radius: 3px;
            text-shadow: 1px 1px 1px #000;
            z-index: 5;
        }

        /* Kingdom Specific Colors */
        #OYUNCU_BOLGE_A, #OYUNCU_BOLGE_B, #OYUNCU_BOLGE_C { background-color: #42a5f5; }
        #YENI_RAKIP_BOLGE_B, #YENI_RAKIP_BOLGE_C { background-color: #616161; }
        #RIVAL_K1_A, #RIVAL_K1_B, #RIVAL_K1_C { background-color: #ef5350; }
        #RIVAL_K2 { background-color: #ffca28; }
        #RIVAL_K3 { background-color: #66bb6a; }
        #RIVAL_K4 { background-color: #ab47bc; }
        #RIVAL_K5_A { background-color: #00bcd4; }
        
        .water-area { background-color: #81d4fa !important; cursor: default !important; border-color: #5cacee; }
        .water-area:hover { transform: none; box-shadow: none; }
        .mountain-area { background-color: #a1887f !important; cursor: default !important; border-color: #795548; }
        .mountain-area:hover { transform: none; box-shadow: none; }

        #info-and-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; border: 1px solid #ccd1d9; padding: 15px; background-color: #f7f9fc; border-radius: 6px; }
        .info-section { padding: 12px; border: 1px solid #dde2e7; background-color: #ffffff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .info-section h4 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #e7eaf0; padding-bottom: 6px; color: #333; }
        .info-section p { margin: 5px 0; font-size: 0.9em; color: #555; }
        #kingdom-name-display { grid-column: 1 / -1; text-align: center; font-size: 1.3em; font-weight: bold; margin-bottom: 15px; padding: 8px; background-color: #e3e9ef; border: 1px solid #c8d0d8; border-radius: 4px; color: #2c3e50; }
        #main-controls { display: flex; justify-content: space-around; margin-bottom: 20px; }
        #main-controls button { padding: 12px 22px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, border-bottom-color 0.2s, transform 0.1s; min-width: 160px; }
        #main-controls button:hover:not(:disabled) { transform: translateY(-1px); }
        #main-controls button:disabled { background-color: #d8d8d8; border-bottom: 3px solid #b8b8b8; color: #888; cursor: not-allowed; }
        #attack-btn { background-color: #d9534f; border-bottom: 3px solid #c9302c; }
        #attack-btn:hover:not(:disabled) { background-color: #c9302c; border-bottom-color: #ac2925; }
        #barracks-btn { background-color: #5cb85c; border-bottom: 3px solid #4cae4c; }
        #barracks-btn:hover:not(:disabled) { background-color: #4cae4c; border-bottom-color: #398439; }
        #tax-btn { background-color: #f0ad4e; border-bottom: 3px solid #eea236; }
        #tax-btn:hover:not(:disabled) { background-color: #eea236; border-bottom-color: #d58512; }

        #game-management-controls, #turn-controls { display: flex; justify-content: center; gap: 15px; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #e3e9ef; border-radius: 6px; }
        #game-management-controls button, #turn-controls button { padding: 10px 20px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        #save-game-btn { background-color: #337ab7; border-bottom: 3px solid #286090; }
        #save-game-btn:hover { background-color: #286090; border-bottom-color: #1f4c73; transform: translateY(-1px); }
        #new-game-btn { background-color: #f0ad4e; border-bottom: 3px solid #eea236; }
        #new-game-btn:hover { background-color: #eea236; border-bottom-color: #d58512; transform: translateY(-1px); }
        #show-tutorial-btn { background-color: #6c757d; border-bottom: 3px solid #5a6268;}
        #show-tutorial-btn:hover { background-color: #5a6268; border-bottom-color: #495057; transform: translateY(-1px); }
        #next-turn-btn { background-color: #5bc0de; border-bottom: 3px solid #46b8da; font-size: 1.1em !important; padding: 12px 28px !important;}
        #next-turn-btn:hover { background-color: #46b8da; border-bottom-color: #31b0d5; transform: translateY(-1px); }
        #turn-display { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        #messages-container { border: 1px solid #ccd1d9; padding: 10px; background-color: #f7f9fc; margin-top: 15px; border-radius: 6px; }
        #messages-container h4 { margin-top:0; color: #333; border-bottom: 1px solid #e7eaf0; padding-bottom: 5px;}
        #messages { min-height: 40px; overflow-y: auto; max-height: 100px; background-color: #fff; padding: 8px; border-radius: 4px; border: 1px solid #dde2e7; }
        .message-item { padding: 4px 0; border-bottom: 1px dashed #e7eaf0; font-size: 0.9em; color: #555; }
        .message-item:last-child { border-bottom: none; }
        .rebellion { color: #c9302c !important; font-weight: bold; }
        .battle_win { color: #4cae4c !important; font-weight: bold; }
        .battle_lose { color: #d9534f !important; font-weight: bold; }
        .success { color: #3c763d !important; }
        .error { color: #a94442 !important; }
        .info { color: #31708f !important; }

        /* --- Modal Stilleri --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.65); padding-top: 50px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #bbb; width: 88%; max-width: 520px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.25); position: relative; }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content h3, .modal-content h4 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #e0e0e0; padding-bottom:8px; margin-bottom:15px;}
        .modal-content label { display: block; margin: 10px 0 5px; font-weight: 600; color: #444;}
        .modal-content input[type="number"], .modal-content input[type="range"] { width: 96%; padding: 0; margin-bottom: 10px; }
        .modal-buttons { margin-top: 20px; text-align: right; }
        .modal-buttons button { padding: 10px 20px; margin-left: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; transition: background-color 0.2s, transform 0.1s; }
        .close-btn { background-color: #f0ad4e; color: white; border-bottom: 2px solid #eea236;}
        .close-btn:hover { background-color: #eea236; transform: translateY(-1px); }
        .action-btn { background-color: #5cb85c; color: white; border-bottom: 2px solid #4cae4c; }
        .action-btn:hover { background-color: #4cae4c; transform: translateY(-1px); }
        
        #prev-tutorial-btn, #prev-combat-tutorial-btn { background-color: #777; border-bottom-color: #555; }
        #prev-tutorial-btn:hover, #prev-combat-tutorial-btn:hover { background-color: #666; }

        /* --- Geli≈ümi≈ü Rehber Stilleri --- */
        .highlight-tutorial-element {
            box-shadow: 0 0 0 4px rgba(91, 192, 222, 0.8) !important;
            border-radius: 6px;
            transition: box-shadow 0.4s ease-in-out;
            position: relative;
            z-index: 10001 !important;
        }
        #tutorial-popover {
            display: none;
            position: absolute; 
            z-index: 10002; 
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 20px;
            max-width: 350px;
            transition: top 0.3s ease, left 0.3s ease;
            border-left: 5px solid #5bc0de;
        }
        #tutorial-popover::after { 
            content: '';
            position: absolute;
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }
        #tutorial-popover.arrow-top::after {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-bottom: 10px solid #f9f9f9;
        }
        #tutorial-popover.arrow-bottom::after {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-top: 10px solid #f9f9f9;
        }
        #tutorial-popover h3 { margin-top: 0; color: #31708f; border-bottom: 1px solid #e0e0e0; padding-bottom:8px; margin-bottom:15px; }
        #tutorial-popover p { font-size: 1.05em; line-height: 1.6; color: #333; }
        #tutorial-popover .modal-buttons button { padding: 10px 22px; }

        #combat-tutorial-modal .modal-content { border-left: 5px solid #337ab7; }

        /* BATTLE MODAL STYLES */
        #battle-grid, #defense-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .battle-tile { background-color: #f0f4f8; border: 1px solid #cdd5df; border-radius: 5px; padding: 10px; }
        .battle-tile h5 { margin: 0 0 8px 0; text-align: center; border-bottom: 1px solid #e1e8f0; padding-bottom: 5px; }
        .slider-container { display: flex; align-items: center; margin: 4px 0; }
        .slider-container label { flex-basis: 80px; font-size: 0.9em; }
        .slider-container input[type="range"] { flex-grow: 1; margin: 0 10px; }
        .tile-power { text-align: center; font-size: 0.8em; margin-top: 5px; font-weight: bold; }
        #available-army-display p, #garrison-army-display p { margin: 2px 0; font-weight: bold; }
        #available-army-display span, #garrison-army-display span { margin: 0 5px; }

        /* --- Mobil Cihazlar ƒ∞√ßin Duyarlƒ±lƒ±k Ayarlarƒ± --- */
        @media (max-width: 768px) {
            #main-controls, #game-management-controls {
                flex-wrap: wrap; 
                gap: 10px;
            }

            #info-and-controls {
                grid-template-columns: 1fr; 
            }
            
            #map-container {
                grid-template-columns: repeat(2, 1fr); 
                grid-template-rows: repeat(10, 100px); 
            }

            #tutorial-popover {
                position: fixed !important; 
                bottom: 0;
                left: 0;
                right: 0;
                top: auto !important;
                transform: none !important;
                width: auto;
                max-width: 100%;
                border-radius: 12px 12px 0 0; 
                border-bottom: none;
            }

            #tutorial-popover::after {
                display: none; 
            }
        }
    </style>
</head>
<body>

    <div id="start-menu">
        <h1>Taht Sava≈ülarƒ±</h1>
        <input type="text" id="kingdom-name-input" placeholder="Krallƒ±ƒüƒ±nƒ±zƒ±n Adƒ±nƒ± Girin..." value="">
        <button id="play-button">Oyuna Ba≈üla</button>
    </div>

    <div id="game-window">
        <div id="map-container">
            <div class="map-region" id="RIVAL_K3"><span class="region-name">Batƒ± Baronluƒüu</span><span class="region-owner"></span></div>
            <div class="map-region" id="NEUTRAL_1"><span class="region-name">Terkedilmi≈ü Tarƒ±m Arazileri</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K1_A"><span class="region-name">K.M. (Batƒ±)</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K1_B"><span class="region-name">K.M. (Doƒüu)</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K2"><span class="region-name">Doƒüu Beyliƒüi</span><span class="region-owner"></span></div>
            <div class="map-region" id="OYUNCU_BOLGE_B"><span class="region-name">G√ºney Kalesi</span><span class="region-owner"></span></div>
            <div class="map-region" id="OYUNCU_BOLGE_A"><span class="region-name">Ba≈ükent</span><span class="region-owner"></span></div>
            <div class="map-region" id="OYUNCU_BOLGE_C"><span class="region-name">Doƒüu G√∂zc√º Kulesi</span><span class="region-owner"></span></div>
            <div class="map-region mountain-area" id="MOUNTAIN_1"><span class="region-name">Ejderha Sƒ±rtƒ± Daƒülarƒ±</span></div>
            <div class="map-region" id="NEUTRAL_2"><span class="region-name">Eski Harabeler</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K1_C"><span class="region-name">K.M. (G√ºney)</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K5_A"><span class="region-name">Sessiz Kƒ±yƒ±</span><span class="region-owner"></span></div>
            <div class="map-region water-area" id="LAKE_1"><span class="region-name">B√ºy√ºk G√∂l</span></div>
            <div class="map-region" id="NEUTRAL_3"><span class="region-name">Ticaret Yolu</span><span class="region-owner"></span></div>
            <div class="map-region" id="YENI_RAKIP_BOLGE_C"><span class="region-name">G√ºney Karakolu</span><span class="region-owner"></span></div>
            <div class="map-region" id="RIVAL_K4"><span class="region-name">Daƒü Kabileleri</span><span class="region-owner"></span></div>
            <div class="map-region" id="NEUTRAL_4"><span class="region-name">Sisli Vadi</span><span class="region-owner"></span></div>
            <div class="map-region water-area" id="LAKE_2"><span class="region-name">Huzur Nehri</span></div>
            <div class="map-region" id="NEUTRAL_5"><span class="region-name">Issƒ±z Topraklar</span><span class="region-owner"></span></div>
            <div class="map-region" id="YENI_RAKIP_BOLGE_B"><span class="region-name">Demir Kale</span><span class="region-owner"></span></div>
        </div>
        <div id="info-and-controls">
            <div id="kingdom-name-display">Krallƒ±k Bilgileri</div>
            <div class="info-section" id="army-stats">
                <h4>‚öîÔ∏è Ordu</h4>
                <p>üö∂ Piyade: <span id="infantry-count">0</span></p>
                <p>üèπ Ok√ßu: <span id="archer-count">0</span></p>
                <p>üêé Atlƒ±: <span id="cavalry-count">0</span></p>
            </div>
            <div class="info-section" id="treasury-stats">
                <h4>üí∞ Hazine</h4>
                <p>ü™ô Altƒ±n: <span id="gold-amount">0</span></p>
                <p>üìà Gelir (Tahmini): <span id="income-estimate">0</span></p>
                <p>üìâ Gider (Tahmini): <span id="upkeep-estimate">0</span></p>
            </div>
            <div class="info-section" id="population-stats">
                <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ N√ºfus</h4>
                <p>Toplam: <span id="total-population">0</span></p>
                <p>Askere Hazƒ±r: <span id="recruitable-population">0</span></p>
                <p>üòä Mutluluk: <span id="happiness-level">0</span>%</p>
                <p>Vergi Oranƒ±: <span id="tax-rate-display">0</span>%</p>
            </div>
        </div>
        <div id="main-controls">
            <button id="barracks-btn">Kararg√¢h</button>
            <button id="tax-btn">Vergi ve Maliyet</button>
            <button id="attack-btn">Sava≈ü A√ß</button>
        </div>
        <div id="game-management-controls">
            <button id="save-game-btn">Oyunu Kaydet</button>
            <button id="new-game-btn">Yeni Oyun</button>
            <button id="show-tutorial-btn">Rehberi G√∂ster</button>
        </div>
        <div id="turn-controls">
            <div id="turn-display">Tur: 1</div>
            <button id="next-turn-btn">Turu Bitir</button>
        </div>
        <div id="messages-container">
          <h4>Olaylar ve Mesajlar:</h4>
          <div id="messages">Hen√ºz bir olay yok.</div>
        </div>
    </div>

    <div id="barracks-modal" class="modal">
        <div class="modal-content">
            <h3>Kararg√¢h - Asker Alƒ±mƒ±</h3>
            <p>Askere Hazƒ±r N√ºfus: <span id="modal-recruitable-pop">0</span></p>
            <p>Mevcut Altƒ±n: <span id="modal-current-gold">0</span></p>
            <div id="recruit-sliders">
                <div class="slider-container">
                    <label for="recruit-infantry-slider">üö∂ Piyade: <span id="recruit-infantry-value">0</span></label>
                    <input type="range" id="recruit-infantry-slider" value="0" min="0" step="1">
                </div>
                <div class="slider-container">
                    <label for="recruit-archer-slider">üèπ Ok√ßu: <span id="recruit-archer-value">0</span></label>
                    <input type="range" id="recruit-archer-slider" value="0" min="0" step="1">
                </div>
                <div class="slider-container">
                    <label for="recruit-cavalry-slider">üêé Atlƒ±: <span id="recruit-cavalry-value">0</span></label>
                    <input type="range" id="recruit-cavalry-slider" value="0" min="0" step="1">
                </div>
            </div>
            <p>Toplam Maliyet: <span id="total-recruit-cost">0</span> Altƒ±n</p>
            <p>Kullanƒ±lacak N√ºfus: <span id="total-recruit-pop">0</span></p>
            <div class="modal-buttons">
                <button class="close-btn" id="close-barracks-btn">Kapat</button>
                <button class="action-btn" id="confirm-recruit-btn">Asker Al</button>
            </div>
        </div>
    </div>
    
    <div id="tax-modal" class="modal">
        <div class="modal-content">
            <h3>Vergi ve Maliyet</h3>
            <div class="slider-container">
                <label for="tax-rate-slider">üí∏ Vergi Oranƒ± (%): <span id="tax-rate-value">10</span></label>
                <input type="range" id="tax-rate-slider" min="0" max="50" value="10">
            </div>
            <p>Tahmini G√ºnl√ºk Gelir: <span id="modal-income">0</span> Altƒ±n</p>
            <p>Tahmini G√ºnl√ºk Asker Gideri: <span id="modal-upkeep">0</span> Altƒ±n</p>
            <p>ƒ∞syan Riski: <span id="rebellion-risk">D√º≈ü√ºk</span></p>
            <div class="modal-buttons">
                <button class="close-btn" id="close-tax-btn">Kapat</button>
                <button class="action-btn" id="confirm-tax-btn">Onayla</button>
            </div>
        </div>
    </div>
    
    <div id="game-over-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: #d9534f;">Krallƒ±ƒüƒ±nƒ±z Yƒ±kƒ±ldƒ±!</h3>
            <p>Maalesef taht sava≈üƒ±nƒ± kaybettiniz. Ama her son yeni bir ba≈ülangƒ±√ßtƒ±r.</p>
            <div class="modal-buttons" style="justify-content: center; display: flex;">
                <button class="action-btn" id="game-over-new-game-btn" style="background-color: #5cb85c;">Yeni Oyun Ba≈ülat</button>
            </div>
        </div>
    </div>
    
    <div id="tutorial-choice-modal" class="modal">
        <div class="modal-content">
            <h3>Rehber Se√ßimi</h3>
            <p>Hangi konuda yardƒ±m almak istersiniz?</p>
            <div class="modal-buttons" style="display:flex; justify-content: space-around;">
                 <button class="action-btn" id="start-main-tutorial-btn">Genel Oyun Rehberi</button>
                 <button class="action-btn" id="start-combat-tutorial-btn" style="background-color:#337ab7">Sava≈ü Sistemi Rehberi</button>
                 <button class="close-btn" id="close-tutorial-choice-btn">Kapat</button>
            </div>
        </div>
    </div>
    
    <div id="tutorial-popover">
        <h3 id="tutorial-title">Oyuna Ho≈ü Geldin!</h3>
        <p id="tutorial-text">Bu rehber sana oyunun temellerini √∂ƒüretecek.</p>
        <div class="modal-buttons">
            <button class="action-btn" id="prev-tutorial-btn" style="display:none;">Geri</button>
            <button class="action-btn" id="next-tutorial-btn">ƒ∞leri</button>
            <button class="close-btn" id="end-tutorial-btn" style="display:none;">Rehberi Kapat</button>
        </div>
    </div>
    
    <div id="combat-tutorial-modal" class="modal">
        <div class="modal-content">
            <h3 id="combat-tutorial-title">Sava≈ü Sistemi</h3>
            <p id="combat-tutorial-text">Sava≈üƒ±n kurallarƒ±nƒ± √∂ƒüren.</p>
            <div class="modal-buttons">
                <button class="action-btn" id="prev-combat-tutorial-btn" style="display:none;">Geri</button>
                <button class="action-btn" id="next-combat-tutorial-btn">ƒ∞leri</button>
                <button class="close-btn" id="end-combat-tutorial-btn" style="display:none;">Rehberi Kapat</button>
            </div>
        </div>
    </div>
    
    <div id="battle-modal" class="modal">
        <div class="modal-content modal-lg">
            <h3 id="battle-modal-title">Sava≈ü Planƒ±</h3>
            <div id="available-army-display">
                <p>Kullanƒ±labilir Ordu:</p>
                <span>üö∂<span id="available-infantry">0</span></span>
                <span>üèπ<span id="available-archer">0</span></span>
                <span>üêé<span id="available-cavalry">0</span></span>
            </div>
            <hr>
            <div id="battle-grid"></div>
            <div class="modal-buttons">
                <button class="close-btn" id="close-battle-modal-btn">Geri √áekil</button>
                <button class="action-btn" id="confirm-battle-plan-btn" style="background-color: #d9534f;">Saldƒ±rƒ±yƒ± Ba≈ülat!</button>
            </div>
        </div>
    </div>
    
    <div id="defense-modal" class="modal">
        <div class="modal-content modal-lg">
            <h3 id="defense-modal-title">Savunma Planƒ±</h3>
            <p>Krallƒ±ƒüƒ±nƒ±z saldƒ±rƒ± altƒ±nda! Askerlerinizi 4 b√∂lgeye daƒüƒ±tarak ≈üehrinizi savunun.</p>
            <div id="garrison-army-display">
                 <p>Savunma Ordusu:</p>
                <span>üö∂<span id="garrison-infantry">0</span></span>
                <span>üèπ<span id="garrison-archer">0</span></span>
                <span>üêé<span id="garrison-cavalry">0</span></span>
            </div>
            <hr>
            <div id="defense-grid"></div>
            <div class="modal-buttons">
                <button class="action-btn" id="confirm-defense-plan-btn">Savunmayƒ± Ba≈ülat!</button>
            </div>
        </div>
    </div>

    <audio id="gameplay-music"></audio>
    <audio id="sfx-barracks" src="audio/barracks_open.wav"></audio>
    <audio id="sfx-tax" src="audio/tax_open.wav"></audio>
    <audio id="sfx-attack" src="audio/attack_plan.wav"></audio>
    <audio id="sfx-defense-alert" src="audio/defense_alert.wav"></audio>
    <audio id="sfx-victory" src="audio/zafer.wav"></audio>
    <audio id="sfx-defeat" src="audio/bozgun.wav"></audio>

    <script>
        const gameplayMusic = document.getElementById('gameplay-music');
        const sfxBarracks = document.getElementById('sfx-barracks');
        const sfxTax = document.getElementById('sfx-tax');
        const sfxAttack = document.getElementById('sfx-attack');
        const sfxDefenseAlert = document.getElementById('sfx-defense-alert');
        const sfxVictory = document.getElementById('sfx-victory');
        const sfxDefeat = document.getElementById('sfx-defeat');

        const gameplayPlaylist = [
            'audio/gameplay1.mp3',
            'audio/gameplay2.mp3',
            'audio/gameplay3.mp3'
        ];
        let currentTrackIndex = 0;

        // --- BA≈ûLANGI√á VE TEMEL OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
        const PLAYER_KINGDOM_ID = "OYUNCU_KRALLIGI";
        const NEW_POWERFUL_RIVAL_ID = "DEMIR_YUMRUK_IMPARATORLUGU";
        const REBELS_ID = "ISYANCILAR"; // YENƒ∞: ƒ∞syancƒ± krallƒ±ƒüƒ± ID'si

        let KINGDOM_DETAILS = {
            [PLAYER_KINGDOM_ID]: { name: "Benim Krallƒ±ƒüƒ±m", color: "#42a5f5", isPlayer: true, aiControlled: false },
            [NEW_POWERFUL_RIVAL_ID]: { name: "Demir Yumruk ƒ∞mparatorluƒüu", color: "#616161", aiControlled: true },
            [REBELS_ID]: { name: "ƒ∞syancƒ±lar", color: "#757575", aiControlled: true, isRebel: true }, // YENƒ∞: ƒ∞syancƒ± krallƒ±ƒüƒ±
            RIVAL_K1: { name: "Kuzey Muhafƒ±zlarƒ±", color: "#ef5350", aiControlled: true },
            RIVAL_K2: { name: "Doƒüu Beyliƒüi", color: "#ffca28", aiControlled: true },
            RIVAL_K3: { name: "Batƒ± Baronluƒüu", color: "#66bb6a", aiControlled: true },
            RIVAL_K4: { name: "Daƒü Kabileleri", color: "#ab47bc", aiControlled: true },
            RIVAL_K5: { name: "G√∂l Kenarƒ± Lordlarƒ±", color: "#00bcd4", aiControlled: true },
        };
        const UNIT_STATS = {
            infantry: { price: 10, upkeep: 1, name: "Piyade", power: 1.0 },
            archer: { price: 15, upkeep: 2, name: "Ok√ßu", power: 1.25 },
            cavalry: { price: 30, upkeep: 3, name: "Atlƒ±", power: 1.5 }
        };

        const REGION_ADJACENCY = {
            "RIVAL_K3": ["NEUTRAL_1", "OYUNCU_BOLGE_B"],
            "NEUTRAL_1": ["RIVAL_K3", "RIVAL_K1_A", "OYUNCU_BOLGE_A", "OYUNCU_BOLGE_B"],
            "RIVAL_K1_A": ["NEUTRAL_1", "RIVAL_K1_B", "OYUNCU_BOLGE_A", "MOUNTAIN_1"],
            "RIVAL_K1_B": ["RIVAL_K1_A", "RIVAL_K2", "MOUNTAIN_1"],
            "RIVAL_K2": ["RIVAL_K1_B", "NEUTRAL_2"],
            "OYUNCU_BOLGE_B": ["RIVAL_K3", "NEUTRAL_1", "OYUNCU_BOLGE_A", "RIVAL_K1_C"],
            "OYUNCU_BOLGE_A": ["OYUNCU_BOLGE_B", "NEUTRAL_1", "RIVAL_K1_A", "OYUNCU_BOLGE_C"],
            "OYUNCU_BOLGE_C": ["OYUNCU_BOLGE_A", "MOUNTAIN_1", "LAKE_1", "RIVAL_K5_A"],
            "MOUNTAIN_1": ["RIVAL_K1_A", "RIVAL_K1_B", "OYUNCU_BOLGE_C", "NEUTRAL_2", "LAKE_1", "NEUTRAL_3"],
            "NEUTRAL_2": ["RIVAL_K2", "MOUNTAIN_1", "YENI_RAKIP_BOLGE_C", "NEUTRAL_3"],
            "RIVAL_K1_C": ["OYUNCU_BOLGE_B", "RIVAL_K5_A", "RIVAL_K4"],
            "RIVAL_K5_A": ["RIVAL_K1_C", "OYUNCU_BOLGE_C", "LAKE_1", "NEUTRAL_4"],
            "LAKE_1": ["OYUNCU_BOLGE_C", "MOUNTAIN_1", "RIVAL_K5_A", "NEUTRAL_3"],
            "NEUTRAL_3": ["MOUNTAIN_1", "NEUTRAL_2", "LAKE_1", "LAKE_2", "YENI_RAKIP_BOLGE_C"],
            "YENI_RAKIP_BOLGE_C": ["NEUTRAL_2", "NEUTRAL_3", "YENI_RAKIP_BOLGE_B"],
            "RIVAL_K4": ["RIVAL_K1_C", "NEUTRAL_4"],
            "NEUTRAL_4": ["RIVAL_K4", "RIVAL_K5_A", "LAKE_2", "NEUTRAL_5"],
            "LAKE_2": ["NEUTRAL_3", "NEUTRAL_4", "YENI_RAKIP_BOLGE_B", "NEUTRAL_5"],
            "NEUTRAL_5": ["NEUTRAL_4", "LAKE_2", "YENI_RAKIP_BOLGE_B"],
            "YENI_RAKIP_BOLGE_B": ["YENI_RAKIP_BOLGE_C", "LAKE_2", "NEUTRAL_5"]
        };

        let gameState = {};
        
        // --- Oyun ƒ∞√ßi M√ºzik D√∂ng√ºs√º ---
        gameplayMusic.addEventListener('ended', () => {
            currentTrackIndex++;
            if (currentTrackIndex >= gameplayPlaylist.length) {
                currentTrackIndex = 0; 
            }
            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
            gameplayMusic.play();
        });

        // --- Geli≈ümi≈ü Rehber Sistemi ---
        const tutorialPopover = document.getElementById('tutorial-popover');
        const tutorialTextEl = document.getElementById('tutorial-text');
        const tutorialTitleEl = document.getElementById('tutorial-title');
        const nextTutorialBtn = document.getElementById('next-tutorial-btn');
        const prevTutorialBtn = document.getElementById('prev-tutorial-btn');
        const endTutorialBtn = document.getElementById('end-tutorial-btn');
        let currentTutorialStepIdx = 0;
        let highlightedElement = null;
        
        const combatTutorialModal = document.getElementById('combat-tutorial-modal');
        const combatTutorialTextEl = document.getElementById('combat-tutorial-text');
        const combatTutorialTitleEl = document.getElementById('combat-tutorial-title');
        const nextCombatTutorialBtn = document.getElementById('next-combat-tutorial-btn');
        const prevCombatTutorialBtn = document.getElementById('prev-combat-tutorial-btn');
        const endCombatTutorialBtn = document.getElementById('end-combat-tutorial-btn');
        let currentCombatTutorialStepIdx = 0;
        
        const tutorialChoiceModal = document.getElementById('tutorial-choice-modal');
        document.getElementById('show-tutorial-btn').addEventListener('click', () => tutorialChoiceModal.style.display = 'block');
        document.getElementById('close-tutorial-choice-btn').addEventListener('click', () => tutorialChoiceModal.style.display = 'none');
        document.getElementById('start-main-tutorial-btn').addEventListener('click', () => {
            tutorialChoiceModal.style.display = 'none';
            startTutorial();
        });
        document.getElementById('start-combat-tutorial-btn').addEventListener('click', () => {
            tutorialChoiceModal.style.display = 'none';
            startCombatTutorial();
        });

        const tutorialSteps = [
            { title: "Oyuna Ho≈ü Geldin!", text: "Taht Sava≈ülarƒ±'na ho≈ü geldin! Bu rehber sana oyunun temellerini √∂ƒüretecek." },
            { elementId: 'map-container', title: "Harita", text: "Burasƒ± oyun haritasƒ±. Krallƒ±klar ve b√∂lgeler burada yer alƒ±r. B√∂lgelere tƒ±klayarak se√ßebilirsin." },
            { elementId: 'OYUNCU_BOLGE_A', title: "Ba≈ükentin", text: "Bu senin ba≈ülangƒ±√ß b√∂lgen ve ba≈ükentin. Ba≈ükenti kaybetmek oyunu kaybetmek demektir!" },
            { elementId: 'info-and-controls', title: "Krallƒ±k Paneli", text: "Bu panelde krallƒ±ƒüƒ±nƒ±n Ordu, Hazine ve N√ºfus bilgilerini g√∂rebilirsin." },
            { elementId: 'barracks-btn', title: "Kararg√¢h", text: "Kararg√¢h butonu ile yeni askerler alabilirsin. Asker almak i√ßin altƒ±na ve yeterli n√ºfusa ihtiyacƒ±n var." },
            { elementId: 'tax-btn', title: "Vergi ve Maliyet", text: "Vergi butonu ile vergi oranƒ±nƒ± ayarlayabilirsin. Y√ºksek vergi geliri artƒ±rƒ±r ama halkƒ±nƒ±n mutluluƒüunu d√º≈ü√ºr√ºr. Mutsuz halk isyan edebilir!" },
            { elementId: 'attack-btn', title: "Sava≈ü A√ß", text: "Sƒ±nƒ±r kom≈üun olan bir d√º≈üman b√∂lgesine tƒ±kladƒ±ktan sonra bu buton ile sava≈ü ilan edebilirsin." },
            { elementId: 'next-turn-btn', title: "Turu Bitir", text: "Turu Bitir butonu ile zamanƒ± ilerletirsin. Gelirler toplanƒ±r, giderler √∂denir ve diƒüer krallƒ±klar da hamlelerini yapar." },
            { elementId: 'messages-container', title: "Olaylar ve Mesajlar", text: "Oyun i√ßi √∂nemli geli≈ümeler burada bildirilir. Rastgele olaylar, sava≈ü sonu√ßlarƒ± ve ekonomik durumun hakkƒ±nda bilgi alƒ±rsƒ±n." },
            { title: "Rehber Sonu", text: "Rehber tamamlandƒ±! Daha detaylƒ± sava≈ü mekanikleri i√ßin Sava≈ü Sistemi Rehberi'ne g√∂z at. Bol ≈üans!" }
        ];
        
        const combatTutorialSteps = [
            { title: "Sava≈ü Sistemi", text: "Sava≈ülar, bir b√∂lgenin 4 alt karesini temsil eden 2x2'lik bir alanda ger√ßekle≈üir." },
            { title: "Sava≈ü ƒ∞lanƒ±", text: "Kom≈üu bir d√º≈üman b√∂lgesine tƒ±kladƒ±ktan sonra 'Sava≈ü A√ß' butonuna basarsƒ±n. Ordunu 4 kareye daƒüƒ±tacaƒüƒ±n Sava≈ü Planƒ± ekranƒ± a√ßƒ±lƒ±r." },
            { title: "Birim G√º√ßleri", text: "Her birimin bir g√º√ß puanƒ± vardƒ±r: Piyade (1), Ok√ßu (1.25), Atlƒ± (1.5). Bir karedeki toplam g√º√ß, o karenin sonucunu belirler." },
            { title: "Zafer Ko≈üulu", text: "Bir b√∂lgeyi ele ge√ßirmek i√ßin 4 kareden en az 3'√ºn√º kazanman gerekir. Aksi takdirde saldƒ±rƒ±n p√ºsk√ºrt√ºl√ºr ve ordun aƒüƒ±r kayƒ±p verir." },
            { title: "Savunma", text: "Eƒüer sana saldƒ±rƒ±lƒ±rsa, bu sefer sen savunma yapan tarafsƒ±n. Saldƒ±rƒ±ya uƒürayan b√∂lgedeki ordunu 4 kareye daƒüƒ±tarak d√º≈ümanƒ± durdurmaya √ßalƒ±≈üƒ±rsƒ±n." },
            { title: "Savunma Zaferi", text: "Savunmadayken en az 2 kareyi korumayƒ± ba≈üarƒ±rsan (yani rakip 3 kare alamazsa), saldƒ±rƒ±yƒ± p√ºsk√ºrtm√º≈ü olursun." }
        ];

        function startTutorial() {
            currentTutorialStepIdx = 0; 
            showTutorialStep();
        }

        function endTutorial() {
            if(highlightedElement) {
                highlightedElement.classList.remove('highlight-tutorial-element');
                highlightedElement = null;
            }
            tutorialPopover.style.display = 'none';
        }

        function showTutorialStep() {
            if(highlightedElement) {
                highlightedElement.classList.remove('highlight-tutorial-element');
            }
            tutorialPopover.classList.remove('arrow-top', 'arrow-bottom');
            tutorialPopover.style.transform = 'none';

            const step = tutorialSteps[currentTutorialStepIdx];
            if (!step) {
                endTutorial();
                return;
            }
            
            tutorialTitleEl.textContent = step.title;
            tutorialTextEl.textContent = step.text;
            
            const targetElement = step.elementId ? document.getElementById(step.elementId) : null;
            highlightedElement = targetElement;

            if (targetElement) {
                targetElement.classList.add('highlight-tutorial-element');
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                
                setTimeout(() => {
                    // Sadece masa√ºst√ºnde dinamik konumlandƒ±rma yap
                    if (window.innerWidth > 768) {
                        const targetRect = targetElement.getBoundingClientRect();
                        const popoverRect = tutorialPopover.getBoundingClientRect();
                        
                        let top, left;
                        
                        if (targetRect.bottom + popoverRect.height + 20 < window.innerHeight) {
                            top = targetRect.bottom + 10;
                            tutorialPopover.classList.add('arrow-top');
                        } else { 
                            top = targetRect.top - popoverRect.height - 10;
                            tutorialPopover.classList.add('arrow-bottom');
                        }
                        
                        left = targetRect.left + (targetRect.width / 2) - (tutorialPopover.offsetWidth / 2);

                        if (left < 10) left = 10;
                        if (left + tutorialPopover.offsetWidth > window.innerWidth - 10) {
                            left = window.innerWidth - tutorialPopover.offsetWidth - 10;
                        }

                        tutorialPopover.style.top = `${window.scrollY + top}px`;
                        tutorialPopover.style.left = `${window.scrollX + left}px`;
                    } else {
                        tutorialPopover.style.top = '';
                        tutorialPopover.style.left = '';
                    }
                    tutorialPopover.style.display = 'block';

                }, 400);

            } else { 
                tutorialPopover.style.display = 'block';
                 if (window.innerWidth > 768) {
                    tutorialPopover.style.top = '50%';
                    tutorialPopover.style.left = '50%';
                    tutorialPopover.style.transform = 'translate(-50%, -50%)';
                } else {
                    tutorialPopover.style.top = '';
                    tutorialPopover.style.left = '';
                    tutorialPopover.style.transform = '';
                }
            }

            prevTutorialBtn.style.display = currentTutorialStepIdx > 0 ? 'inline-block' : 'none';
            endTutorialBtn.style.display = currentTutorialStepIdx === tutorialSteps.length - 1 ? 'inline-block' : 'none';
            nextTutorialBtn.style.display = currentTutorialStepIdx < tutorialSteps.length - 1 ? 'inline-block' : 'none';
        }

        nextTutorialBtn.addEventListener('click', () => {
            if (currentTutorialStepIdx < tutorialSteps.length - 1) {
                currentTutorialStepIdx++;
                showTutorialStep();
            }
        });
        prevTutorialBtn.addEventListener('click', () => {
            if (currentTutorialStepIdx > 0) {
                currentTutorialStepIdx--;
                showTutorialStep();
            }
        });
        endTutorialBtn.addEventListener('click', endTutorial);

        function startCombatTutorial() { currentCombatTutorialStepIdx = 0; showCombatTutorialStep(); }
        function showCombatTutorialStep() {
             if (currentCombatTutorialStepIdx < 0 || currentCombatTutorialStepIdx >= combatTutorialSteps.length) return;
            const step = combatTutorialSteps[currentCombatTutorialStepIdx];
            combatTutorialTitleEl.textContent = step.title; combatTutorialTextEl.textContent = step.text;
            combatTutorialModal.style.display = 'block';
            prevCombatTutorialBtn.style.display = currentCombatTutorialStepIdx > 0 ? 'inline-block' : 'none';
            endCombatTutorialBtn.style.display = currentCombatTutorialStepIdx === combatTutorialSteps.length - 1 ? 'inline-block' : 'none';
            nextCombatTutorialBtn.style.display = currentCombatTutorialStepIdx < combatTutorialSteps.length - 1 ? 'inline-block' : 'none';
        }
        nextCombatTutorialBtn.addEventListener('click', () => { if (currentCombatTutorialStepIdx < combatTutorialSteps.length - 1) { currentCombatTutorialStepIdx++; showCombatTutorialStep(); } });
        prevCombatTutorialBtn.addEventListener('click', () => { if (currentCombatTutorialStepIdx > 0) { currentCombatTutorialStepIdx--; showCombatTutorialStep(); } });
        endCombatTutorialBtn.addEventListener('click', () => combatTutorialModal.style.display = 'none');

        // --- OYUN KURULUMU VE Y√ñNETƒ∞Mƒ∞ ---
        function createNewGameState(playerName) {
            KINGDOM_DETAILS[PLAYER_KINGDOM_ID].name = playerName;
            const newGameState = {
                turn: 1, upkeepModifier: 1.0, selectedRegionId: "OYUNCU_BOLGE_A", playerKingdomId: PLAYER_KINGDOM_ID,
                kingdoms: {}, regions: {}, messages: [], playerAttackedThisTurn: false, activeBattle: null,
            };
            const regionElementsData = { "OYUNCU_BOLGE_A": { owner: PLAYER_KINGDOM_ID, name: "Ba≈ükent", isCapital: true, population: 15000, recruitablePopBase: 1500 }, "OYUNCU_BOLGE_B": { owner: PLAYER_KINGDOM_ID, name: "G√ºney Kalesi", population: 6000, recruitablePopBase: 500 }, "OYUNCU_BOLGE_C": { owner: PLAYER_KINGDOM_ID, name: "Doƒüu G√∂zc√º Kulesi", population: 5500, recruitablePopBase: 450 }, "YENI_RAKIP_BOLGE_B": { owner: NEW_POWERFUL_RIVAL_ID, name: "Demir Kale", isCapital: true, population: 40000, recruitablePopBase: 4000 }, "YENI_RAKIP_BOLGE_C": { owner: NEW_POWERFUL_RIVAL_ID, name: "G√ºney Karakolu", population: 20000, recruitablePopBase: 1500 }, "RIVAL_K1_A": { owner: "RIVAL_K1", name: "K.M. (Batƒ±)", isCapital: true, population: 12000, recruitablePopBase: 1000 }, "RIVAL_K1_B": { owner: "RIVAL_K1", name: "K.M. (Doƒüu)", population: 8000, recruitablePopBase: 700 }, "RIVAL_K1_C": { owner: "RIVAL_K1", name: "K.M. (G√ºney)", population: 7000, recruitablePopBase: 600 }, "RIVAL_K2": { owner: "RIVAL_K2", name: "Doƒüu Beyliƒüi", isCapital: true, population: 13000, recruitablePopBase: 1100 }, "RIVAL_K3": { owner: "RIVAL_K3", name: "Batƒ± Baronluƒüu", isCapital: true, population: 14000, recruitablePopBase: 1200 }, "RIVAL_K4": { owner: "RIVAL_K4", name: "Daƒü Kabileleri", isCapital: true, population: 10000, recruitablePopBase: 800 }, "RIVAL_K5_A": { owner: "RIVAL_K5", name: "Sessiz Kƒ±yƒ±", isCapital: true, population: 9000, recruitablePopBase: 900 }, "NEUTRAL_1": { owner: null, name: "Terkedilmi≈ü Tarƒ±m Arazileri", population: 2000, recruitablePopBase: 200 }, "NEUTRAL_2": { owner: null, name: "Eski Harabeler", population: 1500, recruitablePopBase: 100 }, "NEUTRAL_3": { owner: null, name: "Ticaret Yolu", population: 3000, recruitablePopBase: 250 }, "NEUTRAL_4": { owner: null, name: "Sisli Vadi", population: 1800, recruitablePopBase: 150 }, "NEUTRAL_5": { owner: null, name: "Issƒ±z Topraklar", population: 1200, recruitablePopBase: 50 }, "LAKE_1": { owner: null, name: "B√ºy√ºk G√∂l", terrain: 'water', conquerable: false, population: 0 }, "LAKE_2": { owner: null, name: "Huzur Nehri", terrain: 'water', conquerable: false, population: 0 }, "MOUNTAIN_1": { owner: null, name: "Ejderha Sƒ±rtƒ± Daƒülarƒ±", terrain: 'mountain', conquerable: false, population: 0 }};
            for (const regionId in regionElementsData) { const data = regionElementsData[regionId]; newGameState.regions[regionId] = { id: regionId, owner: data.owner, name: data.name, isKingdomCapital: !!data.isCapital, terrain: data.terrain || 'plains', conquerable: data.conquerable !== false, infantry: 0, archer: 0, cavalry: 0, population: data.population || 5000, rebellion: null }; }
            for (const kingdomId in KINGDOM_DETAILS) {
                const details = KINGDOM_DETAILS[kingdomId];
                let capitalRegionId = null, totalPopulation = 0, totalRecruitableBase = 0;
                for(const regionId in newGameState.regions){ if(newGameState.regions[regionId].owner === kingdomId){ totalPopulation += newGameState.regions[regionId].population; totalRecruitableBase += regionElementsData[regionId]?.recruitablePopBase || (newGameState.regions[regionId].population * 0.1); if(newGameState.regions[regionId].isKingdomCapital) capitalRegionId = regionId; } }
                if(!capitalRegionId) capitalRegionId = Object.keys(newGameState.regions).find(rId => newGameState.regions[rId].owner === kingdomId);
                newGameState.kingdoms[kingdomId] = { id: kingdomId, name: details.name, isPlayer: !!details.isPlayer, aiControlled: details.aiControlled, gold: details.isPlayer ? 5000 : 1800, population: totalPopulation, recruitablePop: Math.floor(totalRecruitableBase), army: { infantry: details.isPlayer ? 120 : 100, archer: details.isPlayer ? 30 : 50, cavalry: details.isPlayer ? 15 : 20, }, taxRate: 10, happiness: 70, mainRegionId: capitalRegionId, lastExpansionTurn: 1 };
            }
            newGameState.selectedRegionId = newGameState.kingdoms[PLAYER_KINGDOM_ID].mainRegionId;
            return newGameState;
        }
        
        function initializeOrLoadGame() {
            const savedGame = localStorage.getItem('tahtSavaslariGameSave');
            if (savedGame) {
                try {
                    gameState = JSON.parse(savedGame);
                    if (!gameState.turn || !gameState.kingdoms || !gameState.regions) throw new Error("Eksik veri.");
                    KINGDOM_DETAILS[PLAYER_KINGDOM_ID].name = gameState.kingdoms[PLAYER_KINGDOM_ID].name;
                    addMessage("Kaydedilmi≈ü oyun ba≈üarƒ±yla y√ºklendi!", "success");
                    document.getElementById('start-menu').style.display = 'none';
                    document.getElementById('game-window').style.display = 'block';
                    document.body.style.backgroundColor = '#e9ebee';
                    
                    // D√úZELTME: M√ºzik artƒ±k ilk tƒ±klamada ba≈ülayacak
                    function startGameMusicOnFirstClick() {
                        if (gameplayMusic.paused) {
                            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
                            gameplayMusic.play().catch(e => console.error("M√ºzik ba≈ülatƒ±lamadƒ±:", e));
                        }
                        // Dinleyiciyi bir kere √ßalƒ±≈ütƒ±ktan sonra kaldƒ±r
                        document.getElementById('game-window').removeEventListener('click', startGameMusicOnFirstClick);
                    }
                    document.getElementById('game-window').addEventListener('click', startGameMusicOnFirstClick);

                    updateUI();
                    renderMessages();
                } catch (e) {
                    localStorage.removeItem('tahtSavaslariGameSave');
                }
            }
        }
        function saveGame() {
            try {
                localStorage.setItem('tahtSavaslariGameSave', JSON.stringify(gameState));
                addMessage("Oyun ba≈üarƒ±yla kaydedildi!", "success");
            } catch (e) { addMessage("Oyun kaydedilemedi.", "error"); }
        }
        function startNewGame() {
            if (confirm("Emin misiniz? Mevcut ilerlemeniz silinecek ve ba≈ülangƒ±√ß ekranƒ±na d√∂neceksiniz.")) {
                localStorage.removeItem('tahtSavaslariGameSave');
                localStorage.removeItem('tahtSavaslariTutorialCompleted');
                
                gameplayMusic.pause();
                endTutorial(); 

                document.getElementById('game-window').style.display = 'none';
                document.getElementById('start-menu').style.display = 'flex';
                document.body.style.backgroundColor = '#1a1a1a';
            }
        }
        document.getElementById('save-game-btn').addEventListener('click', saveGame);
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('game-over-new-game-btn').addEventListener('click', () => {
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('game-window').style.display = 'none';
            document.getElementById('start-menu').style.display = 'flex';
            document.body.style.backgroundColor = '#1a1a1a';
            gameplayMusic.pause();
        });
        document.getElementById('play-button').addEventListener('click', () => {
            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
            gameplayMusic.play().catch(e => console.log("Kullanƒ±cƒ± etkile≈üimi olmadan oyun i√ßi m√ºzik ba≈ülatƒ±lamadƒ±."));

            let kingdomName = document.getElementById('kingdom-name-input').value.trim();
            if (!kingdomName) kingdomName = "Benim Krallƒ±ƒüƒ±m";

            localStorage.removeItem('tahtSavaslariGameSave');
            localStorage.removeItem('tahtSavaslariTutorialCompleted');
            gameState = createNewGameState(kingdomName);
            addMessage("Yeni oyun ba≈ülatƒ±ldƒ±.", "info");

            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('game-window').style.display = 'block';
            document.body.style.backgroundColor = '#e9ebee';
            document.getElementById('next-turn-btn').disabled = false;
            updateUI();
        });

        // --- UI & DISPLAY ---
        function addMessage(text, type = "normal") { gameState.messages.unshift({ text, type, turn: gameState.turn }); if (gameState.messages.length > 20) gameState.messages.pop(); renderMessages(); }
        function renderMessages() { const messagesEl = document.getElementById('messages'); messagesEl.innerHTML = ''; if (!gameState.messages || gameState.messages.length === 0) { messagesEl.innerHTML = '<div>Hen√ºz bir olay yok.</div>'; return; } gameState.messages.forEach(msg => { const msgEl = document.createElement('div'); msgEl.classList.add('message-item'); if (msg.type) msgEl.classList.add(msg.type); msgEl.textContent = `Tur ${msg.turn}: ${msg.text}`; messagesEl.appendChild(msgEl); }); }
        
        function updateUI() {
            if (!gameState || !gameState.kingdoms || !gameState.playerKingdomId) return;
            const playerKingdom = gameState.kingdoms[gameState.playerKingdomId];
            if (!playerKingdom) { return; }
            document.querySelectorAll('.map-region.selected-region').forEach(el => el.classList.remove('selected-region'));
            if (gameState.selectedRegionId) document.getElementById(gameState.selectedRegionId)?.classList.add('selected-region');
            const selectedRegion = gameState.regions[gameState.selectedRegionId] || {};
            const ownerKingdom = gameState.kingdoms[selectedRegion.owner] || {};

            // D√úZELTME: Krallƒ±k adƒ± g√∂r√ºnt√ºleme hatasƒ± ve ƒ∞syancƒ± garnizonu g√∂sterimi
            let displayText = playerKingdom.name;
            if (selectedRegion.name) {
                if (selectedRegion.owner === REBELS_ID) {
                     displayText = `${selectedRegion.name} (ƒ∞syancƒ±lar) - Savunma: ${selectedRegion.infantry} üö∂`;
                } else {
                     displayText = `${selectedRegion.name} (${ownerKingdom.name || 'Sahipsiz'})`;
                }
            }
            document.getElementById('kingdom-name-display').innerHTML = displayText;
            
            document.getElementById('infantry-count').textContent = playerKingdom.army.infantry;
            document.getElementById('archer-count').textContent = playerKingdom.army.archer;
            document.getElementById('cavalry-count').textContent = playerKingdom.army.cavalry;
            document.getElementById('gold-amount').textContent = playerKingdom.gold;
            document.getElementById('total-population').textContent = playerKingdom.population;
            document.getElementById('recruitable-population').textContent = playerKingdom.recruitablePop;
            document.getElementById('happiness-level').textContent = playerKingdom.happiness;
            document.getElementById('tax-rate-display').textContent = playerKingdom.taxRate;
            document.getElementById('income-estimate').textContent = calculateIncome(playerKingdom);
            document.getElementById('upkeep-estimate').textContent = calculateUpkeep(playerKingdom);
            document.getElementById('turn-display').textContent = `Tur: ${gameState.turn}`;
            for (const regionId in gameState.regions) {
                const regionEl = document.getElementById(regionId);
                if(regionEl){
                    const region = gameState.regions[regionId];
                    const ownerKingdomDetails = KINGDOM_DETAILS[region.owner];
                    const ownerSpan = regionEl.querySelector('.region-owner');
                    if(ownerKingdomDetails) {
                        regionEl.style.backgroundColor = ownerKingdomDetails.color;
                        if(ownerSpan) ownerSpan.textContent = ownerKingdomDetails.name;
                    } else if (region.terrain !== 'plains') {
                        if(ownerSpan) ownerSpan.textContent = "";
                    } else {
                        regionEl.style.backgroundColor = '#b0bec5';
                        if(ownerSpan) ownerSpan.textContent = "Sahipsiz";
                    }
                }
            }
            document.getElementById('attack-btn').disabled = gameState.playerAttackedThisTurn;
            document.getElementById('attack-btn').title = gameState.playerAttackedThisTurn ? "Bu tur zaten sava≈ütƒ±nƒ±z." : "Sava≈ü A√ß";
            renderMessages();
        }
        
        // --- CALCULATIONS & HELPERS ---
        function calculateIncome(kingdom) { if (!kingdom) return 0; return Math.floor(kingdom.population * (kingdom.taxRate / 100) * 0.5); }
        function calculateUpkeep(kingdom) {
            if (!kingdom || !kingdom.army) return 0;
            let totalUpkeep = 0;
            for (const unitType in kingdom.army) {
                if (UNIT_STATS[unitType]) totalUpkeep += kingdom.army[unitType] * UNIT_STATS[unitType].upkeep;
            }
            return Math.floor(totalUpkeep * gameState.upkeepModifier);
        }
        function areKingdomsAdjacent(kingdomId1, kingdomId2) {
            if (!kingdomId1 || !kingdomId2) return false;
            const kingdom1Regions = Object.values(gameState.regions).filter(r => r.owner === kingdomId1);
            for (const region of kingdom1Regions) {
                const neighbors = REGION_ADJACENCY[region.id] || [];
                for (const neighborId of neighbors) {
                    if (gameState.regions[neighborId] && gameState.regions[neighborId].owner === kingdomId2) {
                        return true;
                    }
                }
            }
            return false;
        }

    // --- MODAL & BUTTON LOGIC ---
    const barracksModal = document.getElementById('barracks-modal');
    document.getElementById('barracks-btn').addEventListener('click', () => {
        sfxBarracks.play(); 
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.getElementById('modal-recruitable-pop').textContent = player.recruitablePop;
        document.getElementById('modal-current-gold').textContent = player.gold;
        document.getElementById('recruit-infantry-slider').value = 0;
        document.getElementById('recruit-archer-slider').value = 0;
        document.getElementById('recruit-cavalry-slider').value = 0;
        updateRecruitSliders();
        barracksModal.style.display = 'block';
    });
    document.getElementById('close-barracks-btn').addEventListener('click', () => barracksModal.style.display = 'none');
    document.getElementById('recruit-sliders').addEventListener('input', updateRecruitSliders);

    function updateRecruitSliders() {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const sliders = { infantry: document.getElementById('recruit-infantry-slider'), archer: document.getElementById('recruit-archer-slider'), cavalry: document.getElementById('recruit-cavalry-slider') };
        const values = { infantry: parseInt(sliders.infantry.value), archer: parseInt(sliders.archer.value), cavalry: parseInt(sliders.cavalry.value) };
        let totalCost = (values.infantry * UNIT_STATS.infantry.price) + (values.archer * UNIT_STATS.archer.price) + (values.cavalry * UNIT_STATS.cavalry.price);
        let totalPop = values.infantry + values.archer + values.cavalry;
        while (totalCost > player.gold || totalPop > player.recruitablePop) {
            if (values.cavalry > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.cavalry--; } 
            else if (values.archer > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.archer--; }
            else if (values.infantry > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.infantry--; } 
            else { break; }
            totalCost = (values.infantry * UNIT_STATS.infantry.price) + (values.archer * UNIT_STATS.archer.price) + (values.cavalry * UNIT_STATS.cavalry.price);
            totalPop = values.infantry + values.archer + values.cavalry;
        }
        sliders.infantry.value = values.infantry; sliders.archer.value = values.archer; sliders.cavalry.value = values.cavalry;
        document.getElementById('recruit-infantry-value').textContent = values.infantry;
        document.getElementById('recruit-archer-value').textContent = values.archer;
        document.getElementById('recruit-cavalry-value').textContent = values.cavalry;
        sliders.infantry.max = values.infantry + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.infantry.price));
        sliders.archer.max = values.archer + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.archer.price));
        sliders.cavalry.max = values.cavalry + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.cavalry.price));
        document.getElementById('total-recruit-cost').textContent = totalCost;
        document.getElementById('total-recruit-pop').textContent = totalPop;
    }

    document.getElementById('confirm-recruit-btn').addEventListener('click', () => {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const inf = parseInt(document.getElementById('recruit-infantry-slider').value), arc = parseInt(document.getElementById('recruit-archer-slider').value), cav = parseInt(document.getElementById('recruit-cavalry-slider').value);
        const cost = (inf * UNIT_STATS.infantry.price) + (arc * UNIT_STATS.archer.price) + (cav * UNIT_STATS.cavalry.price), pop = inf + arc + cav;
        if(pop === 0) return; player.gold -= cost; player.recruitablePop -= pop;
        player.army.infantry += inf; player.army.archer += arc; player.army.cavalry += cav;
        addMessage("Orduya yeni askerler katƒ±ldƒ±.", "success");
        barracksModal.style.display = 'none'; updateUI();
    });

    const taxModal = document.getElementById('tax-modal');
    document.getElementById('tax-btn').addEventListener('click', () => {
        sfxTax.play();
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.getElementById('tax-rate-slider').value = player.taxRate;
        updateTaxModalDetails(player); taxModal.style.display = 'block';
    });
    document.getElementById('tax-rate-slider').addEventListener('input', (e) => { const tempPlayer = {...gameState.kingdoms[PLAYER_KINGDOM_ID], taxRate: parseInt(e.target.value) }; updateTaxModalDetails(tempPlayer); });
    function updateTaxModalDetails(kingdom) {
        document.getElementById('tax-rate-value').textContent = kingdom.taxRate;
        document.getElementById('modal-income').textContent = calculateIncome(kingdom);
        document.getElementById('modal-upkeep').textContent = calculateUpkeep(kingdom);
        let risk = "√áok D√º≈ü√ºk";
        if (kingdom.taxRate > 40) risk = "√áok Y√ºksek!"; else if (kingdom.taxRate > 30) risk = "Y√ºksek"; else if (kingdom.taxRate > 20) risk = "Orta"; else if (kingdom.taxRate > 10) risk = "D√º≈ü√ºk";
        document.getElementById('rebellion-risk').textContent = risk;
    }
    document.getElementById('close-tax-btn').addEventListener('click', () => taxModal.style.display = 'none');
    document.getElementById('confirm-tax-btn').addEventListener('click', () => {
        gameState.kingdoms[PLAYER_KINGDOM_ID].taxRate = parseInt(document.getElementById('tax-rate-slider').value);
        addMessage("Vergi oranƒ± g√ºncellendi.", "success");
        taxModal.style.display = 'none'; updateUI();
    });

    // --- SAVA≈û Sƒ∞STEMƒ∞ MANTIƒûI ---
    const battleModal = document.getElementById('battle-modal');
    const defenseModal = document.getElementById('defense-modal');
    document.getElementById('close-battle-modal-btn').addEventListener('click', () => battleModal.style.display = 'none');
    
    document.getElementById('attack-btn').addEventListener('click', () => {
        if (gameState.playerAttackedThisTurn) { addMessage("Bu tur zaten bir sava≈ü ba≈ülattƒ±nƒ±z.", "error"); return; }
        const targetRegion = gameState.regions[gameState.selectedRegionId];
        if (!targetRegion || targetRegion.owner === PLAYER_KINGDOM_ID || !targetRegion.owner) { addMessage("Sava≈ü a√ßmak i√ßin bir d√º≈üman b√∂lgesi se√ßin.", "error"); return; }
        if (targetRegion.owner === REBELS_ID) { // ƒ∞syancƒ±lara saldƒ±rƒ±
             gameState.activeBattle = { attackerId: PLAYER_KINGDOM_ID, defenderId: REBELS_ID, targetRegionId: targetRegion.id, playerRole: 'attacker' };
        } else { // Normal krallƒ±ƒüa saldƒ±rƒ±
             gameState.activeBattle = { attackerId: PLAYER_KINGDOM_ID, defenderId: targetRegion.owner, targetRegionId: targetRegion.id, playerRole: 'attacker' };
        }
        
        sfxAttack.play();
        openBattleModal();
    });

    function openBattleModal() {
        const defender = gameState.kingdoms[gameState.activeBattle.defenderId];
        document.getElementById('battle-modal-title').textContent = `${defender.name} Krallƒ±ƒüƒ±na Sava≈ü Planƒ±`;
        const grid = document.getElementById('battle-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            grid.innerHTML += `<div class="battle-tile" data-tile-id="${i}"><h5>B√∂lge ${i + 1}</h5>
                <div class="slider-container"><label>üö∂<span data-unit-value="infantry">0</span></label><input type="range" min="0" value="0" data-unit="infantry" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="slider-container"><label>üèπ<span data-unit-value="archer">0</span></label><input type="range" min="0" value="0" data-unit="archer" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="slider-container"><label>üêé<span data-unit-value="cavalry">0</span></label><input type="range" min="0" value="0" data-unit="cavalry" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="tile-power">G√º√ß: 0</div></div>`;
        }
        updateAllocationSliders('battle-grid');
        battleModal.style.display = 'block';
    }

    function openDefenseModal() {
        sfxDefenseAlert.play();
        const attacker = gameState.kingdoms[gameState.activeBattle.attackerId];
        document.getElementById('defense-modal-title').textContent = `${attacker.name} Saldƒ±rƒ±sƒ±na Kar≈üƒ± Savunma Planƒ±`;
        const grid = document.getElementById('defense-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            grid.innerHTML += `<div class="battle-tile" data-tile-id="${i}"><h5>B√∂lge ${i + 1}</h5>
                <div class="slider-container"><label>üö∂<span data-unit-value="infantry">0</span></label><input type="range" min="0" value="0" data-unit="infantry" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="slider-container"><label>üèπ<span data-unit-value="archer">0</span></label><input type="range" min="0" value="0" data-unit="archer" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="slider-container"><label>üêé<span data-unit-value="cavalry">0</span></label><input type="range" min="0" value="0" data-unit="cavalry" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="tile-power">G√º√ß: 0</div></div>`;
        }
        updateAllocationSliders('defense-grid');
        defenseModal.style.display = 'block';
    }

    function updateAllocationSliders(gridId) {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const availableArmy = {...player.army};
        const sliders = { infantry: [], archer: [], cavalry: [] };
        let totalAllocated = { infantry: 0, archer: 0, cavalry: 0 };

        document.querySelectorAll(`#${gridId} input[type="range"]`).forEach(slider => sliders[slider.dataset.unit].push(slider));
        Object.keys(sliders).forEach(unitType => { totalAllocated[unitType] = sliders[unitType].reduce((sum, s) => sum + parseInt(s.value), 0); });
        Object.keys(sliders).forEach(unitType => {
            sliders[unitType].forEach(slider => {
                const currentVal = parseInt(slider.value);
                const allocatedElsewhere = totalAllocated[unitType] - currentVal;
                slider.max = availableArmy[unitType] - allocatedElsewhere;
                slider.parentElement.querySelector('span').textContent = currentVal;
                let power = 0;
                slider.closest('.battle-tile').querySelectorAll('input[type="range"]').forEach(s => { power += parseInt(s.value) * UNIT_STATS[s.dataset.unit].power; });
                slider.closest('.battle-tile').querySelector('.tile-power').textContent = `G√º√ß: ${power.toFixed(2)}`;
            });
        });
        const displayPrefix = gridId === 'battle-grid' ? 'available' : 'garrison';
        document.getElementById(`${displayPrefix}-infantry`).textContent = availableArmy.infantry - totalAllocated.infantry;
        document.getElementById(`${displayPrefix}-archer`).textContent = availableArmy.archer - totalAllocated.archer;
        document.getElementById(`${displayPrefix}-cavalry`).textContent = availableArmy.cavalry - totalAllocated.cavalry;
    }
    
    function getPlayerAllocation(gridId) {
        let allocation = {}, totalAllocated = { infantry: 0, archer: 0, cavalry: 0 };
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.querySelectorAll(`#${gridId} .battle-tile`).forEach(tile => {
            const tileId = tile.dataset.tileId;
            const inf = parseInt(tile.querySelector('[data-unit="infantry"]').value);
            const arc = parseInt(tile.querySelector('[data-unit="archer"]').value);
            const cav = parseInt(tile.querySelector('[data-unit="cavalry"]').value);
            allocation[tileId] = { infantry: inf, archer: arc, cavalry: cav };
            totalAllocated.infantry += inf; totalAllocated.archer += arc; totalAllocated.cavalry += cav;
        });
        if (totalAllocated.infantry > player.army.infantry || totalAllocated.archer > player.army.archer || totalAllocated.cavalry > player.army.cavalry) {
            addMessage("Sahip olduƒüunuzdan fazla asker yerle≈ütiremezsiniz!", "error"); return null;
        }
        return allocation;
    }

    function aiDistributeTroops(army) {
        let allocation = {}, armyPool = {...army};
        for (let i = 0; i < 4; i++) { allocation[i] = { infantry: 0, archer: 0, cavalry: 0 }; }
        Object.keys(armyPool).forEach(unitType => {
            let unitsToAllocate = armyPool[unitType];
            while (unitsToAllocate > 0) {
                const targetTile = Math.floor(Math.random() * 4);
                const amount = Math.min(unitsToAllocate, Math.ceil(Math.random() * unitsToAllocate * 0.8) + 1);
                allocation[targetTile][unitType] += amount;
                unitsToAllocate -= amount;
            }
        });
        return allocation;
    }

    document.getElementById('confirm-battle-plan-btn').addEventListener('click', () => {
        const battle = gameState.activeBattle;
        battle.attackerAllocation = getPlayerAllocation('battle-grid');
        if (!battle.attackerAllocation) return;
        
        const defenderId = battle.defenderId;
        const defendingRegion = gameState.regions[battle.targetRegionId];
        let defendingArmy;

        if (defenderId === REBELS_ID) {
            defendingArmy = { infantry: defendingRegion.infantry, archer: 0, cavalry: 0 };
        } else {
            const defender = gameState.kingdoms[defenderId];
            defendingArmy = {...defender.army};
            if (!defendingRegion.isKingdomCapital) {
                Object.keys(defendingArmy).forEach(key => defendingArmy[key] = Math.floor(defendingArmy[key] * 0.4));
            }
        }
        battle.defenderAllocation = aiDistributeTroops(defendingArmy);
        resolveBattle();
        battleModal.style.display = 'none';
    });

     document.getElementById('confirm-defense-plan-btn').addEventListener('click', () => {
        gameState.activeBattle.defenderAllocation = getPlayerAllocation('defense-grid');
        if (!gameState.activeBattle.defenderAllocation) return;
        resolveBattle();
        defenseModal.style.display = 'none';
        finishTurn();
    });

    function resolveBattle() {
        const battle = gameState.activeBattle;
        const attacker = gameState.kingdoms[battle.attackerId];
        const defender = battle.defenderId === REBELS_ID ? null : gameState.kingdoms[battle.defenderId];
        
        let attackerTilesWon = 0;
        for (let i = 0; i < 4; i++) {
            const attTile = battle.attackerAllocation[i];
            const defTile = battle.defenderAllocation[i];
            const attPower = (attTile.infantry * 1) + (attTile.archer * 1.25) + (attTile.cavalry * 1.5);
            const defPower = (defTile.infantry * 1) + (defTile.archer * 1.25) + (defTile.cavalry * 1.5);
            
            if (attPower > defPower) {
                attackerTilesWon++;
                if(defender) {
                    defender.army.infantry -= defTile.infantry; defender.army.archer -= defTile.archer; defender.army.cavalry -= defTile.cavalry;
                }
                attacker.army.infantry -= Math.floor(attTile.infantry * 0.3); attacker.army.archer -= Math.floor(attTile.archer * 0.3); attacker.army.cavalry -= Math.floor(attTile.cavalry * 0.3);
            } else {
                attacker.army.infantry -= attTile.infantry; attacker.army.archer -= attTile.archer; attacker.army.cavalry -= attTile.cavalry;
                if (defender) {
                    defender.army.infantry -= Math.floor(defTile.infantry * 0.3); defender.army.archer -= Math.floor(defTile.archer * 0.3); defender.army.cavalry -= Math.floor(defTile.cavalry * 0.3);
                }
            }
        }
        Object.keys(attacker.army).forEach(k => attacker.army[k] = Math.max(0, attacker.army[k]));
        if(defender) Object.keys(defender.army).forEach(k => defender.army[k] = Math.max(0, defender.army[k]));
        
        if (attackerTilesWon >= 3) {
            addMessage(`${attacker.name}, ${KINGDOM_DETAILS[battle.defenderId].name}'a ait ${gameState.regions[battle.targetRegionId].name} b√∂lgesini fethetti!`, "battle_win");
            gameState.regions[battle.targetRegionId].owner = battle.attackerId;
            gameState.regions[battle.targetRegionId].infantry = 0; // Fethedilen b√∂lgedeki garnizonu sƒ±fƒ±rla
            if(attacker.isPlayer) attacker.lastExpansionTurn = gameState.turn;

            if (battle.attackerId === PLAYER_KINGDOM_ID) sfxVictory.play();
            else if (battle.defenderId === PLAYER_KINGDOM_ID) sfxDefeat.play();

        } else {
            addMessage(`${attacker.name} saldƒ±rƒ±sƒ±, ${KINGDOM_DETAILS[battle.defenderId].name} tarafƒ±ndan p√ºsk√ºrt√ºld√º!`, "battle_lose");
            
            if (battle.isRebellion) {
                 gameState.regions[battle.targetRegionId].owner = REBELS_ID;
                 gameState.regions[battle.targetRegionId].infantry = 100;
            }

            if (battle.attackerId === PLAYER_KINGDOM_ID) sfxDefeat.play();
            else if (battle.defenderId === PLAYER_KINGDOM_ID) sfxVictory.play();
        }
        gameState.activeBattle = null;
        if (attacker.isPlayer) gameState.playerAttackedThisTurn = true;
        updateUI();
    }
    
    document.querySelectorAll('.map-region').forEach(regionEl => {
        regionEl.addEventListener('click', () => {
            gameState.selectedRegionId = regionEl.id;
            updateUI();
        });
    });

    // --- TUR ATLAMA MANTIƒûI ---
    document.getElementById('next-turn-btn').addEventListener('click', startTurn);
    
    function startTurn(){
        const nextTurnBtn = document.getElementById('next-turn-btn');
        if (nextTurnBtn.disabled) return;
        nextTurnBtn.disabled = true;
        
        let continueTurn = processAiTurns();
        if(continueTurn) {
            finishTurn();
        }
    }

    function processAiTurns() {
        // Yapay zeka hamleleri...
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        for (const kId in gameState.kingdoms) {
            const kingdom = gameState.kingdoms[kId];
            if (kingdom.aiControlled && !kingdom.isRebel && kId !== player.id) { // ƒ∞syancƒ±lar saldƒ±rmaz
                if(areKingdomsAdjacent(kId, PLAYER_KINGDOM_ID)) {
                    let aggressionChance = 0.05;
                    if (kingdom.population > player.population * 1.2) aggressionChance += 0.1;
                    if (gameState.turn - player.lastExpansionTurn > 25) aggressionChance += 0.2; 
                    if (Math.random() < aggressionChance) {
                        const targetablePlayerRegions = Object.values(gameState.regions).filter(r => r.owner === PLAYER_KINGDOM_ID && (REGION_ADJACENCY[r.id] || []).some(nId => gameState.regions[nId]?.owner === kId));
                        if(targetablePlayerRegions.length > 0) {
                            const targetRegion = targetablePlayerRegions[Math.floor(Math.random() * targetablePlayerRegions.length)];
                            gameState.activeBattle = { attackerId: kId, defenderId: PLAYER_KINGDOM_ID, targetRegionId: targetRegion.id, playerRole: 'defender', attackerAllocation: aiDistributeTroops(kingdom.army), defenderAllocation: {} };
                            openDefenseModal();
                            return false; // Turu durdur, savunma bekleniyor
                        }
                    }
                }
            }
        }
        return true; // Tur normal devam etsin
    }

    function finishTurn() {
        gameState.turn++;
        gameState.playerAttackedThisTurn = false;
        if (gameState.turn > 1 && gameState.turn % 20 === 0) { gameState.upkeepModifier += 0.05; addMessage(`Artan krallƒ±k masraflarƒ± nedeniyle asker bakƒ±m maliyetleri %5 arttƒ±!`, "info"); }

        for (const kId in gameState.kingdoms) {
            const kingdom = gameState.kingdoms[kId];
            kingdom.gold += calculateIncome(kingdom);
            kingdom.gold -= calculateUpkeep(kingdom);
        }

        // YENƒ∞: ƒ∞syan kontrol√º
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        let rebellionChance = (player.taxRate > 25) ? (player.taxRate - 25) / 100 : 0;
        if (player.happiness < 40) rebellionChance += (40 - player.happiness) / 100;
        
        if (Math.random() < rebellionChance) {
            const potentialRebelRegions = Object.values(gameState.regions).filter(r => r.owner === PLAYER_KINGDOM_ID && !r.isKingdomCapital);
            if (potentialRebelRegions.length > 0) {
                const rebelRegion = potentialRebelRegions[Math.floor(Math.random() * potentialRebelRegions.length)];
                addMessage(`${rebelRegion.name} b√∂lgesinde y√ºksek vergiler ve mutsuzluk nedeniyle isyan √ßƒ±ktƒ±!`, "rebellion");

                if (!gameState.kingdoms[REBELS_ID]) {
                    const details = KINGDOM_DETAILS[REBELS_ID];
                    gameState.kingdoms[REBELS_ID] = { id: REBELS_ID, name: details.name, isPlayer: false, aiControlled: true, gold: 0, population: 0, army: { infantry: 0, archer: 0, cavalry: 0 }};
                }

                gameState.activeBattle = { 
                    attackerId: REBELS_ID, 
                    defenderId: PLAYER_KINGDOM_ID, 
                    targetRegionId: rebelRegion.id, 
                    playerRole: 'defender', 
                    isRebellion: true, // ƒ∞syan sava≈üƒ± olduƒüunu belirt
                    attackerAllocation: aiDistributeTroops({infantry: 100, archer: 0, cavalry: 0}) 
                };
                openDefenseModal();
                return; // Turu durdur, isyan savunmasƒ± bekleniyor
            }
        }

        addMessage(`Tur ${gameState.turn} sona erdi.`, "info");
        updateUI();
        const isGameOver = checkGameEndConditions();
        if (!isGameOver) document.getElementById('next-turn-btn').disabled = false;
    }

    function triggerRandomEvent(kingdom) {
        const events = [ { name: "Kƒ±tlƒ±k", type: "negative", message: "Topraklarƒ±nƒ±zda kƒ±tlƒ±k ba≈ü g√∂sterdi!", cost: 3000, happiness_loss: 10 }, { name: "Salgƒ±n", type: "negative", message: "Ba≈ükentte salgƒ±n hastalƒ±k ortaya √ßƒ±ktƒ±!", pop_loss_percent: 0.10 }, { name: "Haydutlar", type: "negative", message: "Haydutlar hazinenizden altƒ±n √ßaldƒ±!", gold_loss_percent: 0.05 }, { name: "Bereket", type: "positive", message: "Bu yƒ±lki hasat √ßok bereketli ge√ßti!", happiness_gain: 10, gold_gain: 1500 }, { name: "Firar", type: "negative", message: "Bazƒ± askerleriniz ordudan firar etti!", army_loss_percent: 0.05 } ];
        const event = events[Math.floor(Math.random() * events.length)];
        if(event.cost && kingdom.gold < event.cost) return;
        addMessage(`OLAY: ${event.message}`, event.type === 'negative' ? 'error' : 'success');
        if (event.cost) kingdom.gold -= event.cost;
        if (event.gold_gain) kingdom.gold += event.gold_gain;
        if (event.happiness_loss) kingdom.happiness = Math.max(0, kingdom.happiness - event.happiness_loss);
        if (event.happiness_gain) kingdom.happiness = Math.min(100, kingdom.happiness + event.happiness_gain);
        if (event.pop_loss_percent) kingdom.population = Math.floor(kingdom.population * (1 - event.pop_loss_percent));
        if (event.gold_loss_percent) kingdom.gold = Math.floor(kingdom.gold * (1 - event.gold_loss_percent));
        if (event.army_loss_percent) { kingdom.army.infantry = Math.floor(kingdom.army.infantry * (1 - event.army_loss_percent)); kingdom.army.archer = Math.floor(kingdom.army.archer * (1 - event.army_loss_percent)); kingdom.army.cavalry = Math.floor(kingdom.army.cavalry * (1 - event.army_loss_percent)); }
    }
    
    // --- OYUN SONU KONTROL√ú ---
    function checkGameEndConditions() {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        let playerOwnedRegionCount = 0, isGameOver = false;
        for (const regionId in gameState.regions) { if (gameState.regions[regionId].owner === PLAYER_KINGDOM_ID) playerOwnedRegionCount++; }
        const playerCapitalStillOwned = player.mainRegionId && gameState.regions[player.mainRegionId]?.owner === PLAYER_KINGDOM_ID;
        if (playerOwnedRegionCount === 0 || !playerCapitalStillOwned) {
            document.getElementById('game-over-modal').style.display = 'block';
            isGameOver = true;
        }
        if (isGameOver) document.getElementById('next-turn-btn').disabled = true;
        return isGameOver;
    }
    
    initializeOrLoadGame();
</script>
</body>
</html>