<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taht Savaşları</title>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            transition: background-color 0.5s ease;
        }

        #start-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('arka-plan.png');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            width: 728px;
            height: auto;
            border: 2px solid #555;
        }

        #start-menu h1 {
            font-size: 2.5em;
            margin-top: 10px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px #000;
            letter-spacing: 2px;
            color: #fff;
        }

        #start-menu input {
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #888;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            width: 60%;
            max-width: 300px;
            text-align: center;
            color: #333;
        }

        #start-menu button {
            padding: 12px 35px;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(145deg, #65c365, #4caf50);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #start-menu button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        #game-window {
            display: none;
            width: 90%;
            max-width: 1200px;
            background-color: #ffffff;
            border: 1px solid #d1d1d1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 8px;
        }

        #map-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-auto-rows: 120px;
            gap: 10px;
            background-color: #d8e0e8;
            border: 1px solid #b0c4de;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 6px;
        }

        .map-cell {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
        }

        .map-region {
            border: 1px solid #777;
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s, background-color 0.3s;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
        }

        .cell-kingdom-name {
            font-size: 0.7em;
            font-weight: bold;
            color: #334;
            margin-top: 4px;
            text-shadow: 1px 1px 1px #fff;
            text-align: center;
            flex-shrink: 0;
            height: 1.5em;
            line-height: 1.5em;
        }

        .region-internal-name {
            background-color: rgba(0,0,0,0.65);
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        .map-region.selected-region {
            border: 3px solid #ffeb3b;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
        }
        .map-region:hover:not(.selected-region) {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .water-area { background-color: #81d4fa !important; cursor: default !important; border-color: #5cacee !important; }
        .mountain-area { background-color: #a1887f !important; cursor: default !important; border-color: #795548 !important; }
        .water-area:hover, .mountain-area:hover { transform: none; box-shadow: none; }

        #info-and-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; border: 1px solid #ccd1d9; padding: 15px; background-color: #f7f9fc; border-radius: 6px; }
        .info-section { padding: 12px; border: 1px solid #dde2e7; background-color: #ffffff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .info-section h4 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #e7eaf0; padding-bottom: 6px; color: #333; }
        .info-section p { margin: 5px 0; font-size: 0.9em; color: #555; }
        #kingdom-name-display { grid-column: 1 / -1; text-align: center; font-size: 1.3em; font-weight: bold; margin-bottom: 15px; padding: 8px; background-color: #e3e9ef; border: 1px solid #c8d0d8; border-radius: 4px; color: #2c3e50; }
        #main-controls { display: flex; justify-content: space-around; margin-bottom: 20px; }
        #main-controls button { padding: 12px 22px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, border-bottom-color 0.2s, transform 0.1s; min-width: 160px; }
        #main-controls button:hover:not(:disabled) { transform: translateY(-1px); }
        #main-controls button:disabled { background-color: #d8d8d8 !important; border-bottom-color: #b8b8b8 !important; color: #888 !important; cursor: not-allowed !important; }
        #attack-btn { background-color: #d9534f; border-bottom: 3px solid #c9302c; }
        #attack-btn:hover:not(:disabled) { background-color: #c9302c; border-bottom-color: #ac2925; }
        #barracks-btn { background-color: #5cb85c; border-bottom: 3px solid #4cae4c; }
        #barracks-btn:hover:not(:disabled) { background-color: #4cae4c; border-bottom-color: #398439; }
        #tax-btn { background-color: #f0ad4e; border-bottom: 3px solid #eea236; }
        #tax-btn:hover:not(:disabled) { background-color: #eea236; border-bottom-color: #d58512; }

        #game-management-controls, #turn-controls { display: flex; justify-content: center; gap: 15px; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #e3e9ef; border-radius: 6px; }
        #game-management-controls button, #turn-controls button { padding: 10px 20px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        #save-game-btn { background-color: #337ab7; border-bottom: 3px solid #286090; }
        #save-game-btn:hover { background-color: #286090; border-bottom-color: #1f4c73; transform: translateY(-1px); }
        #new-game-btn { background-color: #f0ad4e; border-bottom: 3px solid #eea236; }
        #new-game-btn:hover { background-color: #eea236; border-bottom-color: #d58512; transform: translateY(-1px); }
        #show-tutorial-btn { background-color: #6c757d; border-bottom: 3px solid #5a6268;}
        #show-tutorial-btn:hover { background-color: #5a6268; border-bottom-color: #495057; transform: translateY(-1px); }
        #next-turn-btn { background-color: #5bc0de; border-bottom: 3px solid #46b8da; font-size: 1.1em !important; padding: 12px 28px !important;}
        #next-turn-btn:hover { background-color: #46b8da; border-bottom-color: #31b0d5; transform: translateY(-1px); }
        #turn-display { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        #messages-container { border: 1px solid #ccd1d9; padding: 10px; background-color: #f7f9fc; margin-top: 15px; border-radius: 6px; }
        #messages-container h4 { margin-top:0; color: #333; border-bottom: 1px solid #e7eaf0; padding-bottom: 5px;}
        #messages { min-height: 40px; overflow-y: auto; max-height: 100px; background-color: #fff; padding: 8px; border-radius: 4px; border: 1px solid #dde2e7; }
        .message-item { padding: 4px 0; border-bottom: 1px dashed #e7eaf0; font-size: 0.9em; color: #555; }
        .message-item:last-child { border-bottom: none; }
        .rebellion { color: #c9302c !important; font-weight: bold; }
        .battle_win { color: #4cae4c !important; font-weight: bold; }
        .battle_lose { color: #d9534f !important; font-weight: bold; }
        .success { color: #3c763d !important; }
        .error { color: #a94442 !important; }
        .info { color: #31708f !important; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.65); padding-top: 50px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #bbb; width: 88%; max-width: 520px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.25); position: relative; }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content h3, .modal-content h4 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #e0e0e0; padding-bottom:8px; margin-bottom:15px;}
        .modal-content label { display: block; margin: 10px 0 5px; font-weight: 600; color: #444;}
        .modal-content input[type="number"], .modal-content input[type="range"] { width: 96%; padding: 0; margin-bottom: 10px; }
        .modal-buttons { margin-top: 20px; text-align: right; }
        .modal-buttons button { padding: 10px 20px; margin-left: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; transition: background-color 0.2s, transform 0.1s; }
        .close-btn { background-color: #f0ad4e; color: white; border-bottom: 2px solid #eea236;}
        .close-btn:hover { background-color: #eea236; transform: translateY(-1px); }
        .action-btn { background-color: #5cb85c; color: white; border-bottom: 2px solid #4cae4c; }
        .action-btn:hover { background-color: #4cae4c; transform: translateY(-1px); }

        #prev-tutorial-btn, #prev-combat-tutorial-btn { background-color: #777; border-bottom-color: #555; }
        #prev-tutorial-btn:hover, #prev-combat-tutorial-btn:hover { background-color: #666; }
        
        #tutorial-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 10000;
        }

        .highlight-tutorial-element {
            box-shadow: 0 0 0 4px rgba(91, 192, 222, 0.8) !important;
            border-radius: 6px;
            transition: box-shadow 0.4s ease-in-out;
            position: relative;
            z-index: 10001 !important;
             background-color: #fff;
        }
        #tutorial-popover {
            display: none;
            position: absolute;
            z-index: 10002;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 20px;
            max-width: 350px;
            transition: top 0.3s ease, left 0.3s ease;
            border-left: 5px solid #5bc0de;
        }
        #tutorial-popover::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }
        #tutorial-popover.arrow-top::after {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-bottom: 10px solid #f9f9f9;
        }
        #tutorial-popover.arrow-bottom::after {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-top: 10px solid #f9f9f9;
        }
        #tutorial-popover h3 { margin-top: 0; color: #31708f; border-bottom: 1px solid #e0e0e0; padding-bottom:8px; margin-bottom:15px; }
        #tutorial-popover p { font-size: 1.05em; line-height: 1.6; color: #333; }
        #tutorial-popover .modal-buttons button { padding: 10px 22px; }

        #combat-tutorial-modal .modal-content { border-left: 5px solid #337ab7; }

        #battle-grid, #defense-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .battle-tile { background-color: #f0f4f8; border: 1px solid #cdd5df; border-radius: 5px; padding: 10px; }
        .battle-tile h5 { margin: 0 0 8px 0; text-align: center; border-bottom: 1px solid #e1e8f0; padding-bottom: 5px; }
        .slider-container { display: flex; align-items: center; margin: 4px 0; }
        .slider-container label { flex-basis: 80px; font-size: 0.9em; }
        .slider-container input[type="range"] { flex-grow: 1; margin: 0 10px; }
        .tile-power { text-align: center; font-size: 0.8em; margin-top: 5px; font-weight: bold; }
        #available-army-display p, #garrison-army-display p { margin: 2px 0; font-weight: bold; }
        #available-army-display span, #garrison-army-display span { margin: 0 5px; }

        #tax-penalty-info, #tax-warning { color: #a94442; font-weight: bold; margin-top: 15px; text-align: center;}

        @media (max-width: 768px) {
            #main-controls, #game-management-controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            #info-and-controls {
                grid-template-columns: 1fr;
            }

            #map-container {
                grid-template-columns: repeat(5, 1fr);
                grid-auto-rows: 70px;
                grid-template-rows: none;
                gap: 4px;
                padding: 4px;
            }
            .cell-kingdom-name {
                font-size: 0.55em;
                line-height: 1.2em;
                height: auto;
            }
            .region-internal-name {
                 font-size: 0.7em;
            }

            #tutorial-popover {
                position: fixed !important;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto !important;
                transform: none !important;
                width: auto;
                max-width: 100%;
                border-radius: 12px 12px 0 0;
                border-bottom: none;
            }

            #tutorial-popover.force-center {
                bottom: 50% !important;
                transform: translateY(50%) !important;
                left: 5% !important;
                right: 5% !important;
                border-radius: 12px;
            }

            #tutorial-popover::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="tutorial-overlay"></div>

    <div id="start-menu">
        <h1>Taht Savaşları</h1>
        <input type="text" id="kingdom-name-input" placeholder="Krallığınızın Adını Girin..." value="">
        <button id="play-button">Oyuna Başla</button>
    </div>

    <div id="game-window">
        <div id="map-container">
            </div>
        <div id="info-and-controls">
            <div id="kingdom-name-display">Krallık Bilgileri</div>
            <div class="info-section" id="army-stats">
                <h4>⚔️ Ordu</h4>
                <p>🚶 Piyade: <span id="infantry-count">0</span></p>
                <p>🏹 Okçu: <span id="archer-count">0</span></p>
                <p>🐎 Atlı: <span id="cavalry-count">0</span></p>
            </div>
            <div class="info-section" id="treasury-stats">
                <h4>💰 Hazine</h4>
                <p>🪙 Altın: <span id="gold-amount">0</span></p>
                <p>📈 Gelir (Tahmini): <span id="income-estimate">0</span></p>
                <p>📉 Gider (Tahmini): <span id="upkeep-estimate">0</span></p>
            </div>
            <div class="info-section" id="population-stats">
                <h4>👨‍👩‍👧‍👦 Nüfus</h4>
                <p>Toplam: <span id="total-population">0</span></p>
                <p>Askere Hazır: <span id="recruitable-population">0</span></p>
                <p>😊 Mutluluk: <span id="happiness-level">0</span>%</p>
                <p>Vergi Oranı: <span id="tax-rate-display">0</span>%</p>
            </div>
        </div>
        <div id="main-controls">
            <button id="barracks-btn">Karargâh</button>
            <button id="tax-btn">Vergi ve Maliyet</button>
            <button id="attack-btn">Savaş Aç</button>
        </div>
        <div id="game-management-controls">
            <button id="save-game-btn">Oyunu Kaydet</button>
            <button id="new-game-btn">Yeni Oyun</button>
            <button id="show-tutorial-btn">Rehberi Göster</button>
        </div>
        <div id="turn-controls">
            <div id="turn-display">Tur: 1</div>
            <button id="next-turn-btn">Turu Bitir</button>
        </div>
        <div id="messages-container">
          <h4>Olaylar ve Mesajlar:</h4>
          <div id="messages">Henüz bir olay yok.</div>
        </div>
    </div>

    <div id="barracks-modal" class="modal">
        <div class="modal-content">
            <h3>Karargâh - Asker Alımı</h3>
            <p>Askere Hazır Nüfus: <span id="modal-recruitable-pop">0</span></p>
            <p>Mevcut Altın: <span id="modal-current-gold">0</span></p>
            <div id="recruit-sliders">
                <div class="slider-container">
                    <label for="recruit-infantry-slider">🚶 Piyade: <span id="recruit-infantry-value">0</span></label>
                    <input type="range" id="recruit-infantry-slider" value="0" min="0" step="1">
                </div>
                <div class="slider-container">
                    <label for="recruit-archer-slider">🏹 Okçu: <span id="recruit-archer-value">0</span></label>
                    <input type="range" id="recruit-archer-slider" value="0" min="0" step="1">
                </div>
                <div class="slider-container">
                    <label for="recruit-cavalry-slider">🐎 Atlı: <span id="recruit-cavalry-value">0</span></label>
                    <input type="range" id="recruit-cavalry-slider" value="0" min="0" step="1">
                </div>
            </div>
            <p>Toplam Maliyet: <span id="total-recruit-cost">0</span> Altın</p>
            <p>Kullanılacak Nüfus: <span id="total-recruit-pop">0</span></p>
            <div class="modal-buttons">
                <button class="close-btn" id="close-barracks-btn">Kapat</button>
                <button class="action-btn" id="confirm-recruit-btn">Asker Al</button>
            </div>
        </div>
    </div>

    <div id="tax-modal" class="modal">
        <div class="modal-content">
            <h3>Vergi ve Maliyet</h3>
            <div id="tax-controls">
                <div class="slider-container">
                    <label for="tax-rate-slider">💸 Vergi Oranı (%): <span id="tax-rate-value">10</span></label>
                    <input type="range" id="tax-rate-slider" min="0" max="50" value="10">
                </div>
                <p>Tahmini Günlük Gelir: <span id="modal-income">0</span> Altın</p>
                <p>Tahmini Günlük Asker Gideri: <span id="modal-upkeep">0</span> Altın</p>
                <p>İsyan Riski: <span id="rebellion-risk">Düşük</span></p>
                <p id="tax-warning" class="error" style="display:none; text-align:center; margin-top: 10px;"></p>
            </div>
            <div id="tax-penalty-info" style="display:none;"></div>
            <div class="modal-buttons">
                <button class="close-btn" id="close-tax-btn">Kapat</button>
                <button class="action-btn" id="confirm-tax-btn">Onayla</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: #d9534f;">Krallığınız Yıkıldı!</h3>
            <p>Maalesef taht savaşını kaybettiniz. Ama her son yeni bir başlangıçtır.</p>
            <div class="modal-buttons" style="justify-content: center; display: flex;">
                <button class="action-btn" id="game-over-new-game-btn" style="background-color: #5cb85c;">Yeni Oyun Başlat</button>
            </div>
        </div>
    </div>

    <div id="tutorial-choice-modal" class="modal">
        <div class="modal-content">
            <h3>Rehber Seçimi</h3>
            <p>Hangi konuda yardım almak istersiniz?</p>
            <div class="modal-buttons" style="display:flex; justify-content: space-around;">
                 <button class="action-btn" id="start-main-tutorial-btn">Genel Oyun Rehberi</button>
                 <button class="action-btn" id="start-combat-tutorial-btn" style="background-color:#337ab7">Savaş Sistemi Rehberi</button>
                 <button class="close-btn" id="close-tutorial-choice-btn">Kapat</button>
            </div>
        </div>
    </div>

    <div id="tutorial-popover">
        <h3 id="tutorial-title">Oyuna Hoş Geldin!</h3>
        <p id="tutorial-text">Bu rehber sana oyunun temellerini öğretecek.</p>
        <div class="modal-buttons">
            <button class="action-btn" id="prev-tutorial-btn" style="display:none;">Geri</button>
            <button class="action-btn" id="next-tutorial-btn">İleri</button>
            <button class="close-btn" id="end-tutorial-btn" style="display:none;">Rehberi Kapat</button>
        </div>
    </div>

    <div id="combat-tutorial-modal" class="modal">
        <div class="modal-content">
            <h3 id="combat-tutorial-title">Savaş Sistemi</h3>
            <p id="combat-tutorial-text">Savaşın kurallarını öğren.</p>
            <div class="modal-buttons">
                <button class="action-btn" id="prev-combat-tutorial-btn" style="display:none;">Geri</button>
                <button class="action-btn" id="next-combat-tutorial-btn">İleri</button>
                <button class="close-btn" id="end-combat-tutorial-btn" style="display:none;">Rehberi Kapat</button>
            </div>
        </div>
    </div>

    <div id="battle-modal" class="modal">
        <div class="modal-content modal-lg">
            <h3 id="battle-modal-title">Savaş Planı</h3>
            <div id="available-army-display">
                <p>Kullanılabilir Ordu:</p>
                <span>🚶<span id="available-infantry">0</span></span>
                <span>🏹<span id="available-archer">0</span></span>
                <span>🐎<span id="available-cavalry">0</span></span>
            </div>
            <hr>
            <div id="battle-grid"></div>
            <div class="modal-buttons">
                <button class="close-btn" id="close-battle-modal-btn">Geri Çekil</button>
                <button class="action-btn" id="confirm-battle-plan-btn" style="background-color: #d9534f;">Saldırıyı Başlat!</button>
            </div>
        </div>
    </div>

    <div id="defense-modal" class="modal">
        <div class="modal-content modal-lg">
            <h3 id="defense-modal-title">Savunma Planı</h3>
            <p>Krallığınız saldırı altında! Askerlerinizi 4 bölgeye dağıtarak şehrinizi savunun.</p>
            <div id="garrison-army-display">
                 <p>Savunma Ordusu:</p>
                <span>🚶<span id="garrison-infantry">0</span></span>
                <span>🏹<span id="garrison-archer">0</span></span>
                <span>🐎<span id="garrison-cavalry">0</span></span>
            </div>
            <hr>
            <div id="defense-grid"></div>
            <div class="modal-buttons">
                <button class="action-btn" id="confirm-defense-plan-btn">Savunmayı Başlat!</button>
            </div>
        </div>
    </div>

    <div id="economic-event-modal" class="modal">
        <div class="modal-content" style="border-left: 5px solid #f0ad4e;">
            <h3 id="economic-event-title">Ekonomik Olay</h3>
            <p id="economic-event-text">Krallığınızı etkileyen yeni bir gelişme yaşandı.</p>
            <div class="modal-buttons">
                <button class="action-btn" id="close-economic-event-btn">Anlaşıldı</button>
            </div>
        </div>
    </div>

    <audio id="gameplay-music"></audio>
    <audio id="sfx-barracks" src="audio/barracks_open.wav"></audio>
    <audio id="sfx-tax" src="audio/tax_open.wav"></audio>
    <audio id="sfx-attack" src="audio/attack_plan.wav"></audio>
    <audio id="sfx-defense-alert" src="audio/defense_alert.wav"></audio>
    <audio id="sfx-victory" src="audio/zafer.wav"></audio>
    <audio id="sfx-defeat" src="audio/bozgun.wav"></audio>

    <script>
        const gameplayMusic = document.getElementById('gameplay-music');
        const sfxBarracks = document.getElementById('sfx-barracks');
        const sfxTax = document.getElementById('sfx-tax');
        const sfxAttack = document.getElementById('sfx-attack');
        const sfxDefenseAlert = document.getElementById('sfx-defense-alert');
        const sfxVictory = document.getElementById('sfx-victory');
        const sfxDefeat = document.getElementById('sfx-defeat');

        const gameplayPlaylist = [
            'audio/gameplay1.mp3',
            'audio/gameplay2.mp3',
            'audio/gameplay3.mp3'
        ];
        let currentTrackIndex = 0;

        const PLAYER_KINGDOM_ID = "OYUNCU_KRALLIGI";
        const NEW_POWERFUL_RIVAL_ID = "DEMIR_YUMRUK_IMPARATORLUGU";
        const REBELS_ID = "ISYANCILAR";
        
        const INITIAL_KINGDOM_DETAILS = {
            [PLAYER_KINGDOM_ID]: { name: "Benim Krallığım", color: "#42a5f5", isPlayer: true, aiControlled: false, arma: 'armas/oyuncu_armasi.png' },
            [NEW_POWERFUL_RIVAL_ID]: { name: "Demir Yumruk İmparatorluğu", color: "#616161", aiControlled: true, arma: 'armas/demir_yumruk.png' },
            [REBELS_ID]: { name: "İsyancılar", color: "#757575", aiControlled: true, isRebel: true, arma: 'armas/isyancilar.png' },
            RIVAL_K1: { name: "Kuzey Muhafızları", color: "#ef5350", aiControlled: true, arma: 'armas/kuzey_muhafizlari.png' },
            RIVAL_K2: { name: "Doğu Beyliği", color: "#ffca28", aiControlled: true, arma: 'armas/dogu_beyligi.png' },
            RIVAL_K3: { name: "Batı Baronluğu", color: "#66bb6a", aiControlled: true, arma: 'armas/bati_baronlugu.png' },
            RIVAL_K4: { name: "Dağ Kabileleri", color: "#ab47bc", aiControlled: true, arma: 'armas/dag_kabileleri.png' },
            RIVAL_K5: { name: "Göl Kenarı Lordları", color: "#00bcd4", aiControlled: true, arma: 'armas/gol_kenari_lordlari.png' },
        };
        let KINGDOM_DETAILS = {};

        const INITIAL_UNIT_STATS = {
            infantry: { price: 10, upkeep: 1, name: "Piyade", power: 1.0 },
            archer: { price: 15, upkeep: 2, name: "Okçu", power: 1.25 },
            cavalry: { price: 30, upkeep: 3, name: "Atlı", power: 1.5 }
        };
        let UNIT_STATS = {};

        const ALL_REGION_IDS = [ "RIVAL_K3", "NEUTRAL_1", "RIVAL_K1_A", "RIVAL_K1_B", "RIVAL_K2", "OYUNCU_BOLGE_B", "OYUNCU_BOLGE_A", "OYUNCU_BOLGE_C", "MOUNTAIN_1", "NEUTRAL_2", "RIVAL_K1_C", "RIVAL_K5_A", "LAKE_1", "NEUTRAL_3", "YENI_RAKIP_BOLGE_C", "RIVAL_K4", "NEUTRAL_4", "LAKE_2", "NEUTRAL_5", "YENI_RAKIP_BOLGE_B" ];

        const REGION_ADJACENCY = {
            "RIVAL_K3": ["NEUTRAL_1", "OYUNCU_BOLGE_B"], "NEUTRAL_1": ["RIVAL_K3", "RIVAL_K1_A", "OYUNCU_BOLGE_A", "OYUNCU_BOLGE_B"], "RIVAL_K1_A": ["NEUTRAL_1", "RIVAL_K1_B", "OYUNCU_BOLGE_A", "MOUNTAIN_1"], "RIVAL_K1_B": ["RIVAL_K1_A", "RIVAL_K2", "MOUNTAIN_1"], "RIVAL_K2": ["RIVAL_K1_B", "NEUTRAL_2"], "OYUNCU_BOLGE_B": ["RIVAL_K3", "NEUTRAL_1", "OYUNCU_BOLGE_A", "RIVAL_K1_C"], "OYUNCU_BOLGE_A": ["OYUNCU_BOLGE_B", "NEUTRAL_1", "RIVAL_K1_A", "OYUNCU_BOLGE_C"], "OYUNCU_BOLGE_C": ["OYUNCU_BOLGE_A", "MOUNTAIN_1", "LAKE_1", "RIVAL_K5_A"], "MOUNTAIN_1": ["RIVAL_K1_A", "RIVAL_K1_B", "OYUNCU_BOLGE_C", "NEUTRAL_2", "LAKE_1", "NEUTRAL_3"], "NEUTRAL_2": ["RIVAL_K2", "MOUNTAIN_1", "YENI_RAKIP_BOLGE_C", "NEUTRAL_3"], "RIVAL_K1_C": ["OYUNCU_BOLGE_B", "RIVAL_K5_A", "RIVAL_K4"], "RIVAL_K5_A": ["RIVAL_K1_C", "OYUNCU_BOLGE_C", "LAKE_1", "NEUTRAL_4"], "LAKE_1": ["OYUNCU_BOLGE_C", "MOUNTAIN_1", "RIVAL_K5_A", "NEUTRAL_3"], "NEUTRAL_3": ["MOUNTAIN_1", "NEUTRAL_2", "LAKE_1", "LAKE_2", "YENI_RAKIP_BOLGE_C"], "YENI_RAKIP_BOLGE_C": ["NEUTRAL_2", "NEUTRAL_3", "YENI_RAKIP_BOLGE_B"], "RIVAL_K4": ["RIVAL_K1_C", "NEUTRAL_4"], "NEUTRAL_4": ["RIVAL_K4", "RIVAL_K5_A", "LAKE_2", "NEUTRAL_5"], "LAKE_2": ["NEUTRAL_3", "NEUTRAL_4", "YENI_RAKIP_BOLGE_B", "NEUTRAL_5"], "NEUTRAL_5": ["NEUTRAL_4", "LAKE_2", "YENI_RAKIP_BOLGE_B"], "YENI_RAKIP_BOLGE_B": ["YENI_RAKIP_BOLGE_C", "LAKE_2", "NEUTRAL_5"]
        };

        const REGION_DATA = { "RIVAL_K3": { name: "Batı Baronluğu" }, "NEUTRAL_1": { name: "Terkedilmiş Tarım Arazileri" }, "RIVAL_K1_A": { name: "K.M. (Batı)" }, "RIVAL_K1_B": { name: "K.M. (Doğu)" }, "RIVAL_K2": { name: "Doğu Beyliği" }, "OYUNCU_BOLGE_B": { name: "Güney Kalesi" }, "OYUNCU_BOLGE_A": { name: "Başkent" }, "OYUNCU_BOLGE_C": { name: "Doğu Gözcü Kulesi" }, "MOUNTAIN_1": { name: "Ejderha Sırtı Dağları", terrain: 'mountain', conquerable: false }, "NEUTRAL_2": { name: "Eski Harabeler" }, "RIVAL_K1_C": { name: "K.M. (Güney)" }, "RIVAL_K5_A": { name: "Sessiz Kıyı" }, "LAKE_1": { name: "Büyük Göl", terrain: 'water', conquerable: false }, "NEUTRAL_3": { name: "Ticaret Yolu" }, "YENI_RAKIP_BOLGE_C": { name: "Güney Karakolu" }, "RIVAL_K4": { name: "Dağ Kabileleri" }, "NEUTRAL_4": { name: "Sisli Vadi" }, "LAKE_2": { name: "Huzur Nehri", terrain: 'water', conquerable: false }, "NEUTRAL_5": { name: "Issız Topraklar" }, "YENI_RAKIP_BOLGE_B": { name: "Demir Kale" }};

        let gameState = {};
        
        const economicEvents = [
            { id: "plague", title: "Büyük Veba Salgını", text: "Diyarları kasıp kavuran bir veba salgını krallığınıza ulaştı! Nüfus artışı durma noktasına geldi, halkın morali bozuk ve askerler ek ödeme talep ediyor.", type: "negative", apply: (kingdom) => { kingdom.happiness = Math.max(10, kingdom.happiness - 15); gameState.upkeepModifier += 0.20; addMessage("Veba salgını asker bakım masraflarını arttırdı ve halkın moralini bozdu.", "error"); } },
            { id: "iron_crisis", title: "Demir Krizi", text: "Kıtadaki demir madenlerinde yaşanan kıtlık nedeniyle yeni silah ve zırh üretimi zorlaştı. Piyade ve Atlı birimlerin maliyeti arttı.", type: "negative", apply: () => { UNIT_STATS.infantry.price = Math.floor(UNIT_STATS.infantry.price * 1.5); UNIT_STATS.cavalry.price = Math.floor(UNIT_STATS.cavalry.price * 1.3); addMessage("Demir krizi nedeniyle piyade ve atlı birimlerinin eğitim maliyeti arttı.", "error"); } },
            { id: "drought", title: "Büyük Kuraklık", text: "Toprakları kavuran büyük bir kuraklık tarımsal üretimi vurdu. Vergilerden elde edilen gelir ciddi şekilde azaldı.", type: "negative", apply: (kingdom) => { kingdom.incomeModifier = (kingdom.incomeModifier || 1.0) * 0.7; addMessage("Kuraklık nedeniyle vergi gelirleri %30 azaldı.", "error"); } },
            { id: "bandits", title: "Ticaret Yolları Haydutları", text: "Krallığınızın ticaret yolları haydutların kontrolüne geçti. Tüccarlar artık güvende değil ve vergi gelirleri düşüyor.", type: "negative", apply: (kingdom) => { kingdom.incomeModifier = (kingdom.incomeModifier || 1.0) * 0.85; addMessage("Haydutlar yüzünden ticaret gelirleri %15 azaldı.", "error"); } },
            { id: "harvest", title: "Bereketli Hasat", text: "Bu yılki hasat beklenenden çok daha bereketli oldu! Halkın karnı tok, morali yüksek ve hazine dolup taşıyor.", type: "positive", apply: (kingdom) => { kingdom.happiness = Math.min(100, kingdom.happiness + 10); kingdom.incomeModifier = (kingdom.incomeModifier || 1.0) * 1.2; addMessage("Bereketli hasat sayesinde halkın morali yükseldi ve gelirler %20 arttı.", "success"); } },
            { id: "gold_vein", title: "Altın Damarı Bulundu", text: "Krallığınızın topraklarında yeni bir altın damarı keşfedildi! Hazineye anında büyük miktarda altın eklendi ve gelirleriniz kalıcı olarak arttı.", type: "positive", apply: (kingdom) => { kingdom.gold += 10000; kingdom.incomeModifier = (kingdom.incomeModifier || 1.0) * 1.1; addMessage("Yeni bir altın damarı bulundu! Hazineye 10000 altın eklendi ve gelirler %10 arttı.", "success"); } },
            { id: "strategist", title: "Ünlü Stratejist", text: "Ünü kıtayı aşan bir stratejist, ordunuzu eğitmek ve yönetmek için hizmetinize girdi. Askerlerin bakım masrafları kalıcı olarak azaldı.", type: "positive", apply: () => { gameState.upkeepModifier = Math.max(0.5, gameState.upkeepModifier - 0.25); addMessage("Ünlü bir stratejist masrafları düşürdü. Asker bakım giderleri %25 azaldı.", "success"); } }
        ];
        let triggeredEconomicEvents = [];

        gameplayMusic.addEventListener('ended', () => {
            currentTrackIndex = (currentTrackIndex + 1) % gameplayPlaylist.length;
            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
            gameplayMusic.play();
        });
        
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialPopover = document.getElementById('tutorial-popover');
        const tutorialTextEl = document.getElementById('tutorial-text');
        const tutorialTitleEl = document.getElementById('tutorial-title');
        const nextTutorialBtn = document.getElementById('next-tutorial-btn');
        const prevTutorialBtn = document.getElementById('prev-tutorial-btn');
        const endTutorialBtn = document.getElementById('end-tutorial-btn');
        let currentTutorialStepIdx = 0;
        let highlightedElement = null;

        const combatTutorialModal = document.getElementById('combat-tutorial-modal');
        const combatTutorialTextEl = document.getElementById('combat-tutorial-text');
        const combatTutorialTitleEl = document.getElementById('combat-tutorial-title');
        const nextCombatTutorialBtn = document.getElementById('next-combat-tutorial-btn');
        const prevCombatTutorialBtn = document.getElementById('prev-combat-tutorial-btn');
        const endCombatTutorialBtn = document.getElementById('end-combat-tutorial-btn');
        let currentCombatTutorialStepIdx = 0;

        const tutorialChoiceModal = document.getElementById('tutorial-choice-modal');
        document.getElementById('show-tutorial-btn').addEventListener('click', () => tutorialChoiceModal.style.display = 'block');
        document.getElementById('close-tutorial-choice-btn').addEventListener('click', () => tutorialChoiceModal.style.display = 'none');
        document.getElementById('start-main-tutorial-btn').addEventListener('click', () => {
            tutorialChoiceModal.style.display = 'none';
            startTutorial();
        });
        document.getElementById('start-combat-tutorial-btn').addEventListener('click', () => {
            tutorialChoiceModal.style.display = 'none';
            startCombatTutorial();
        });

        const tutorialSteps = [
            { title: "Oyuna Hoş Geldin!", text: "Taht Savaşları'na hoş geldin! Bu rehber sana oyunun temellerini öğretecek." },
            { elementId: 'map-container', title: "Harita", text: "Burası oyun haritası. Krallıklar ve bölgeler burada yer alır. Bölgelere tıklayarak seçebilirsin." },
            { elementId: 'OYUNCU_BOLGE_A', title: "Başkentin", text: "Bu senin başlangıç bölgen ve başkentin. Başkenti kaybetmek oyunu kaybetmek demektir!" },
            { elementId: 'info-and-controls', title: "Krallık Paneli", text: "Bu panelde krallığının Ordu, Hazine ve Nüfus bilgilerini görebilirsin." },
            { elementId: 'barracks-btn', title: "Karargâh", text: "Karargâh butonu ile yeni askerler alabilirsin. Asker almak için altına ve yeterli nüfusa ihtiyacın var." },
            { elementId: 'tax-btn', title: "Vergi ve Maliyet", text: "Vergi butonu ile vergi oranını ayarlayabilirsin. Yüksek vergi geliri artırır ama halkının mutluluğunu düşürür. Mutsuz halk isyan edebilir!" },
            { elementId: 'attack-btn', title: "Savaş Aç", text: "Sınır komşun olan bir düşman bölgesine tıkladıktan sonra bu buton ile savaş ilan edebilirsin." },
            { elementId: 'next-turn-btn', title: "Turu Bitir", text: "Turu Bitir butonu ile zamanı ilerletirsin. Gelirler toplanır, giderler ödenir ve diğer krallıklar da hamlelerini yapar." },
            { elementId: 'messages-container', title: "Olaylar ve Mesajlar", text: "Oyun içi önemli gelişmeler burada bildirilir. Rastgele olaylar, savaş sonuçları ve ekonomik durumun hakkında bilgi alırsın." },
            { title: "Rehber Sonu", text: "Rehber tamamlandı! Daha detaylı savaş mekanikleri için Savaş Sistemi Rehberi'ne göz at. Bol şans!" }
        ];

        const combatTutorialSteps = [
            { title: "Savaş Sistemi", text: "Savaşlar, bir bölgenin 4 alt karesini temsil eden 2x2'lik bir alanda gerçekleşir." },
            { title: "Savaş İlanı", text: "Komşu bir düşman bölgesine tıkladıktan sonra 'Savaş Aç' butonuna basarsın. Ordunu 4 kareye dağıtacağın Savaş Planı ekranı açılır." },
            { title: "Birim Güçleri", text: "Her birimin bir güç puanı vardır: Piyade (1), Okçu (1.25), Atlı (1.5). Bir karedeki toplam güç, o karenin sonucunu belirler." },
            { title: "Zafer Koşulu", text: "Bir bölgeyi ele geçirmek için 4 kareden en az 3'ünü kazanman gerekir. Aksi takdirde saldırın püskürtülür ve ordun ağır kayıp verir." },
            { title: "Savunma", text: "Eğer sana saldırılırsa, bu sefer sen savunma yapan tarafsın. Saldırıya uğrayan bölgedeki ordunu 4 kareye dağıtarak düşmanı durdurmaya çalışırsın." },
            { title: "Savunma Zaferi", text: "Savunmadayken en az 2 kareyi korumayı başarırsan (yani rakip 3 kare alamazsa), saldırıyı püskürtmüş olursun." }
        ];
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function startTutorial() {
            const playerCapitalId = gameState.kingdoms[PLAYER_KINGDOM_ID].mainRegionId;
            const capitalStep = tutorialSteps.find(step => step.title === "Başkentin");
            if(capitalStep) capitalStep.elementId = playerCapitalId;
            
            tutorialOverlay.style.display = 'block';
            currentTutorialStepIdx = 0;
            showTutorialStep();
        }
        function endTutorial() {
            if(highlightedElement) {
                highlightedElement.classList.remove('highlight-tutorial-element');
                highlightedElement = null;
            }
            tutorialPopover.style.display = 'none';
            tutorialOverlay.style.display = 'none';
        }

        function showTutorialStep() {
            if(highlightedElement) {
                highlightedElement.classList.remove('highlight-tutorial-element');
            }
            tutorialPopover.classList.remove('arrow-top', 'arrow-bottom', 'force-center');
            tutorialPopover.style.transform = 'none';

            const step = tutorialSteps[currentTutorialStepIdx];
            if (!step) {
                endTutorial();
                return;
            }

            tutorialTitleEl.textContent = step.title;
            tutorialTextEl.textContent = step.text;

            const targetElement = step.elementId ? document.getElementById(step.elementId) : null;
            highlightedElement = targetElement;

            if (targetElement) {
                targetElement.classList.add('highlight-tutorial-element');
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                setTimeout(() => {
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile && step.elementId === 'messages-container') {
                        tutorialPopover.classList.add('force-center');
                    } else if (isMobile) {
                        tutorialPopover.style.top = '';
                        tutorialPopover.style.left = '';
                    } else {
                        const targetRect = targetElement.getBoundingClientRect();
                        const popoverRect = tutorialPopover.getBoundingClientRect();
                        let top, left;
                        if (targetRect.bottom + popoverRect.height + 20 < window.innerHeight) {
                            top = targetRect.bottom + 10;
                            tutorialPopover.classList.add('arrow-top');
                        } else {
                            top = targetRect.top - popoverRect.height - 10;
                            tutorialPopover.classList.add('arrow-bottom');
                        }
                        left = targetRect.left + (targetRect.width / 2) - (tutorialPopover.offsetWidth / 2);
                        if (left < 10) left = 10;
                        if (left + tutorialPopover.offsetWidth > window.innerWidth - 10) {
                            left = window.innerWidth - tutorialPopover.offsetWidth - 10;
                        }
                        tutorialPopover.style.top = `${window.scrollY + top}px`;
                        tutorialPopover.style.left = `${window.scrollX + left}px`;
                    }
                    tutorialPopover.style.display = 'block';
                }, 400);

            } else {
                tutorialPopover.style.display = 'block';
                 if (window.innerWidth > 768) {
                    tutorialPopover.style.top = '50%';
                    tutorialPopover.style.left = '50%';
                    tutorialPopover.style.transform = 'translate(-50%, -50%)';
                } else {
                    tutorialPopover.style.top = '';
                    tutorialPopover.style.left = '';
                    tutorialPopover.style.transform = '';
                }
            }

            prevTutorialBtn.style.display = currentTutorialStepIdx > 0 ? 'inline-block' : 'none';
            endTutorialBtn.style.display = currentTutorialStepIdx === tutorialSteps.length - 1 ? 'inline-block' : 'none';
            nextTutorialBtn.style.display = currentTutorialStepIdx < tutorialSteps.length - 1 ? 'inline-block' : 'none';
        }

        nextTutorialBtn.addEventListener('click', () => { if (currentTutorialStepIdx < tutorialSteps.length - 1) { currentTutorialStepIdx++; showTutorialStep(); } });
        prevTutorialBtn.addEventListener('click', () => { if (currentTutorialStepIdx > 0) { currentTutorialStepIdx--; showTutorialStep(); } });
        endTutorialBtn.addEventListener('click', endTutorial);

        function startCombatTutorial() { currentCombatTutorialStepIdx = 0; showCombatTutorialStep(); }
        function showCombatTutorialStep() {
             if (currentCombatTutorialStepIdx < 0 || currentCombatTutorialStepIdx >= combatTutorialSteps.length) return;
            const step = combatTutorialSteps[currentCombatTutorialStepIdx];
            combatTutorialTitleEl.textContent = step.title; combatTutorialTextEl.textContent = step.text;
            combatTutorialModal.style.display = 'block';
            prevCombatTutorialBtn.style.display = currentCombatTutorialStepIdx > 0 ? 'inline-block' : 'none';
            endCombatTutorialBtn.style.display = currentCombatTutorialStepIdx === combatTutorialSteps.length - 1 ? 'inline-block' : 'none';
            nextCombatTutorialBtn.style.display = currentCombatTutorialStepIdx < combatTutorialSteps.length - 1 ? 'inline-block' : 'none';
        }
        nextCombatTutorialBtn.addEventListener('click', () => { if (currentCombatTutorialStepIdx < combatTutorialSteps.length - 1) { currentCombatTutorialStepIdx++; showCombatTutorialStep(); } });
        prevCombatTutorialBtn.addEventListener('click', () => { if (currentCombatTutorialStepIdx > 0) { currentCombatTutorialStepIdx--; showCombatTutorialStep(); } });
        endCombatTutorialBtn.addEventListener('click', () => combatTutorialModal.style.display = 'none');

        // --- OYUN KURULUMU VE YÖNETİMİ ---
        function createNewGameState(playerName) {
            KINGDOM_DETAILS = JSON.parse(JSON.stringify(INITIAL_KINGDOM_DETAILS));
            UNIT_STATS = JSON.parse(JSON.stringify(INITIAL_UNIT_STATS));
            triggeredEconomicEvents = [];

            KINGDOM_DETAILS[PLAYER_KINGDOM_ID].name = playerName;
            const newGameState = {
                turn: 1, upkeepModifier: 1.0, selectedRegionId: null, playerKingdomId: PLAYER_KINGDOM_ID,
                kingdoms: {}, regions: {}, messages: [], playerAttackedThisTurn: false, activeBattle: null, taxPenaltyTurns: 0,
                nextEconomicEventTurn: Math.floor(Math.random() * 5) + 6, 
            };

            const allKingdomIds = Object.keys(KINGDOM_DETAILS).filter(id => id !== REBELS_ID);
            const landRegions = Object.keys(REGION_DATA).filter(id => REGION_DATA[id].conquerable !== false);
            shuffleArray(landRegions);

            for(const regionId of ALL_REGION_IDS) {
                const data = REGION_DATA[regionId] || {};
                newGameState.regions[regionId] = {
                    id: regionId, owner: null, name: data.name || regionId,
                    isKingdomCapital: false,
                    terrain: data.terrain || 'plains', conquerable: data.conquerable !== false,
                    infantry: 0, archer: 0, cavalry: 0
                };
            }

            const playerAndAiKingdoms = allKingdomIds.filter(id => !KINGDOM_DETAILS[id].isRebel);

            const playerCapital = landRegions.pop();
            newGameState.regions[playerCapital].owner = PLAYER_KINGDOM_ID;
            newGameState.regions[playerCapital].isKingdomCapital = true;
            
            const adjacentToCapital = (REGION_ADJACENCY[playerCapital] || []).filter(id => landRegions.includes(id));
            const playerSecondRegion = adjacentToCapital.length > 0 ? adjacentToCapital[0] : landRegions.pop();
            if(playerSecondRegion) {
                 newGameState.regions[playerSecondRegion].owner = PLAYER_KINGDOM_ID;
                 landRegions.splice(landRegions.indexOf(playerSecondRegion), 1);
            }
           
            const aiKingdoms = playerAndAiKingdoms.filter(id => id !== PLAYER_KINGDOM_ID);
            aiKingdoms.forEach(kId => {
                if(landRegions.length > 0) {
                    const regionId = landRegions.pop();
                    newGameState.regions[regionId].owner = kId;
                    newGameState.regions[regionId].isKingdomCapital = true;
                }
            });

            shuffleArray(landRegions);
            let currentAiIndex = 0;
             while(landRegions.length > 0) {
                const regionToAssign = landRegions.pop();
                newGameState.regions[regionToAssign].owner = aiKingdoms[currentAiIndex];
                currentAiIndex = (currentAiIndex + 1) % aiKingdoms.length;
            }

            for (const kingdomId of allKingdomIds) {
                const details = KINGDOM_DETAILS[kingdomId];
                let capitalRegionId = null, totalPopulation = 0;
                Object.values(newGameState.regions).filter(r => r.owner === kingdomId).forEach(r => {
                    r.population = 5000 + Math.floor(Math.random() * 5000);
                    totalPopulation += r.population;
                    if(r.isKingdomCapital) capitalRegionId = r.id;
                });

                newGameState.kingdoms[kingdomId] = {
                    id: kingdomId, name: details.name, isPlayer: !!details.isPlayer, aiControlled: details.aiControlled,
                    gold: details.isPlayer ? 5000 : 1800,
                    population: totalPopulation,
                    recruitablePop: Math.floor(totalPopulation * 0.1),
                    army: { infantry: details.isPlayer ? 120 : 100, archer: details.isPlayer ? 30 : 50, cavalry: details.isPlayer ? 15 : 20 },
                    taxRate: 10, happiness: 70, mainRegionId: capitalRegionId, lastExpansionTurn: 1, incomeModifier: 1.0
                };
            }
            newGameState.selectedRegionId = newGameState.kingdoms[PLAYER_KINGDOM_ID].mainRegionId;
            return newGameState;
        }

        function initializeOrLoadGame() {
            const savedGame = localStorage.getItem('tahtSavaslariGameSave');
            if (savedGame) {
                try {
                    gameState = JSON.parse(savedGame);
                    if (!gameState.turn || !gameState.kingdoms || !gameState.regions) throw new Error("Eksik veri.");
                    
                    // Restore non-serializable parts from defaults
                    KINGDOM_DETAILS = JSON.parse(JSON.stringify(INITIAL_KINGDOM_DETAILS));
                    UNIT_STATS = JSON.parse(JSON.stringify(INITIAL_UNIT_STATS));
                    
                    KINGDOM_DETAILS[PLAYER_KINGDOM_ID].name = gameState.kingdoms[PLAYER_KINGDOM_ID].name;
                    if (gameState.triggeredEvents) {
                         gameState.triggeredEvents.forEach(eventId => {
                            const event = economicEvents.find(e => e.id === eventId);
                            if (event && event.type === 'negative' && event.id === 'iron_crisis') {
                                event.apply(); 
                            }
                         });
                         triggeredEconomicEvents = gameState.triggeredEvents;
                    }


                    addMessage("Kaydedilmiş oyun başarıyla yüklendi!", "success");
                    document.getElementById('start-menu').style.display = 'none';
                    document.getElementById('game-window').style.display = 'block';
                    document.body.style.backgroundColor = '#e9ebee';

                    function startGameMusicOnFirstClick() {
                        if (gameplayMusic.paused) {
                            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
                            gameplayMusic.play().catch(e => console.error("Müzik başlatılamadı:", e));
                        }
                        document.getElementById('game-window').removeEventListener('click', startGameMusicOnFirstClick);
                    }
                    document.getElementById('game-window').addEventListener('click', startGameMusicOnFirstClick);

                    renderMap();
                    updateUI();
                    renderMessages();
                } catch (e) {
                    console.error("Oyun yüklenemedi:", e);
                    localStorage.removeItem('tahtSavaslariGameSave');
                }
            }
        }
        function saveGame() {
            try {
                gameState.triggeredEvents = triggeredEconomicEvents;
                localStorage.setItem('tahtSavaslariGameSave', JSON.stringify(gameState));
                addMessage("Oyun başarıyla kaydedildi!", "success");
            } catch (e) { addMessage("Oyun kaydedilemedi.", "error"); }
        }
        function startNewGame() {
            if (confirm("Emin misiniz? Mevcut ilerlemeniz silinecek ve başlangıç ekranına döneceksiniz.")) {
                localStorage.removeItem('tahtSavaslariGameSave');
                localStorage.removeItem('tahtSavaslariTutorialCompleted');

                gameplayMusic.pause();
                endTutorial();
                gameState = {}; // Reset game state

                document.getElementById('game-window').style.display = 'none';
                document.getElementById('start-menu').style.display = 'flex';
                document.body.style.backgroundColor = '#000000';
            }
        }
        document.getElementById('save-game-btn').addEventListener('click', saveGame);
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('game-over-new-game-btn').addEventListener('click', () => {
            document.getElementById('game-over-modal').style.display = 'none';
            startNewGame();
        });
        document.getElementById('play-button').addEventListener('click', () => {
            gameplayMusic.src = gameplayPlaylist[currentTrackIndex];
            gameplayMusic.play().catch(e => console.log("Kullanıcı etkileşimi olmadan oyun içi müzik başlatılamadı."));

            let kingdomName = document.getElementById('kingdom-name-input').value.trim();
            if (!kingdomName) kingdomName = "Benim Krallığım";

            localStorage.removeItem('tahtSavaslariGameSave');
            localStorage.removeItem('tahtSavaslariTutorialCompleted');
            gameState = createNewGameState(kingdomName);
            addMessage(`Tur ${gameState.turn}: Yeni oyun başlatıldı.`, "info");

            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('game-window').style.display = 'block';
            document.body.style.backgroundColor = '#e9ebee';
            document.getElementById('next-turn-btn').disabled = false;

            renderMap();
            updateUI();
            
            if (!localStorage.getItem('tahtSavaslariTutorialCompleted')) {
                setTimeout(() => {
                    tutorialChoiceModal.style.display = 'block';
                    localStorage.setItem('tahtSavaslariTutorialCompleted', 'true');
                }, 1000);
            }
        });

        function renderMap(){
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = '';
            ALL_REGION_IDS.forEach(regionId => {
                const data = REGION_DATA[regionId] || {};
                const cell = document.createElement('div');
                cell.className = 'map-cell';

                const regionDiv = document.createElement('div');
                regionDiv.className = 'map-region';
                regionDiv.id = regionId;

                const kingdomNameDiv = document.createElement('div');
                kingdomNameDiv.className = 'cell-kingdom-name';

                if (data.conquerable === false) {
                    regionDiv.classList.add(data.terrain === 'water' ? 'water-area' : 'mountain-area');
                    regionDiv.innerHTML = `<span class="region-internal-name">${data.name}</span>`;
                } else {
                    regionDiv.addEventListener('click', () => {
                        gameState.selectedRegionId = regionId;
                        updateUI();
                    });
                }

                cell.appendChild(regionDiv);
                cell.appendChild(kingdomNameDiv);
                mapContainer.appendChild(cell);
            });
        }

        function addMessage(text, type = "normal") { gameState.messages.unshift({ text, type, turn: gameState.turn }); if (gameState.messages.length > 20) gameState.messages.pop(); renderMessages(); }
        function renderMessages() { const messagesEl = document.getElementById('messages'); messagesEl.innerHTML = ''; if (!gameState.messages || gameState.messages.length === 0) { messagesEl.innerHTML = '<div>Henüz bir olay yok.</div>'; return; } gameState.messages.forEach(msg => { const msgEl = document.createElement('div'); msgEl.classList.add('message-item'); if (msg.type) msgEl.classList.add(msg.type); msgEl.textContent = msg.text; messagesEl.appendChild(msgEl); }); }

        function updateUI() {
            if (!gameState || !gameState.kingdoms || !gameState.playerKingdomId) return;
            const playerKingdom = gameState.kingdoms[gameState.playerKingdomId];
            if (!playerKingdom) { return; }
            document.querySelectorAll('.map-region.selected-region').forEach(el => el.classList.remove('selected-region'));
            if (gameState.selectedRegionId) document.getElementById(gameState.selectedRegionId)?.classList.add('selected-region');
            const selectedRegion = gameState.regions[gameState.selectedRegionId] || {};
            const ownerKingdom = gameState.kingdoms[selectedRegion.owner] || {};

            let displayText = playerKingdom.name;
            if (selectedRegion.name) {
                if (selectedRegion.owner === REBELS_ID) {
                     displayText = `${selectedRegion.name} (İsyancılar) - Savunma: ${selectedRegion.infantry} 🚶`;
                } else if (ownerKingdom && ownerKingdom.name) {
                     displayText = `${selectedRegion.name} (${ownerKingdom.name})`;
                } else if(REGION_DATA[selectedRegion.id] && REGION_DATA[selectedRegion.id].conquerable === false) {
                     displayText = selectedRegion.name;
                } else {
                     displayText = `${selectedRegion.name} (Sahipsiz)`;
                }
            }
            document.getElementById('kingdom-name-display').innerHTML = displayText;

            document.getElementById('infantry-count').textContent = playerKingdom.army.infantry;
            document.getElementById('archer-count').textContent = playerKingdom.army.archer;
            document.getElementById('cavalry-count').textContent = playerKingdom.army.cavalry;
            document.getElementById('gold-amount').textContent = playerKingdom.gold;
            document.getElementById('total-population').textContent = playerKingdom.population;
            document.getElementById('recruitable-population').textContent = playerKingdom.recruitablePop;
            document.getElementById('happiness-level').textContent = playerKingdom.happiness;
            document.getElementById('tax-rate-display').textContent = playerKingdom.taxRate;
            document.getElementById('income-estimate').textContent = calculateIncome(playerKingdom);
            document.getElementById('upkeep-estimate').textContent = calculateUpkeep(playerKingdom);
            document.getElementById('turn-display').textContent = `Tur: ${gameState.turn}`;

            document.querySelectorAll('.map-cell').forEach(cell => {
                const regionDiv = cell.querySelector('.map-region');
                if(!regionDiv) return;

                const nameDiv = cell.querySelector('.cell-kingdom-name');
                const region = gameState.regions[regionDiv.id];
                if(region && region.conquerable){
                    const ownerKingdomDetails = KINGDOM_DETAILS[region.owner];

                    if (ownerKingdomDetails && ownerKingdomDetails.arma) {
                        regionDiv.style.backgroundImage = `url('${ownerKingdomDetails.arma}')`;
                        regionDiv.style.backgroundColor = 'transparent';
                         regionDiv.innerHTML = `<span class="region-internal-name">${REGION_DATA[region.id].name}</span>`;
                    } else {
                        regionDiv.style.backgroundImage = 'none';
                        regionDiv.style.backgroundColor = ownerKingdomDetails ? ownerKingdomDetails.color : '#b0bec5';
                        regionDiv.innerHTML = `<span class="region-internal-name">${REGION_DATA[region.id].name}</span>`;
                    }
                    if(nameDiv) {
                        nameDiv.textContent = ownerKingdomDetails ? ownerKingdomDetails.name : 'Sahipsiz';
                    }
                }
            });

            document.getElementById('attack-btn').disabled = gameState.playerAttackedThisTurn;
            document.getElementById('attack-btn').title = gameState.playerAttackedThisTurn ? "Bu tur zaten savaştınız." : "Savaş Aç";

            const taxBtn = document.getElementById('tax-btn');
            if (gameState.taxPenaltyTurns > 0) {
                taxBtn.disabled = true;
                taxBtn.title = `Vergi değişikliği için ${gameState.taxPenaltyTurns} tur beklemelisiniz.`;
            } else {
                taxBtn.disabled = false;
                taxBtn.title = '';
            }

            renderMessages();
        }

        function calculateIncome(kingdom) { if (!kingdom) return 0; return Math.floor(kingdom.population * (kingdom.taxRate / 100) * 0.5 * (kingdom.incomeModifier || 1.0)); }
        function calculateUpkeep(kingdom) {
            if (!kingdom || !kingdom.army) return 0;
            let totalUpkeep = 0;
            for (const unitType in kingdom.army) {
                if (UNIT_STATS[unitType]) totalUpkeep += kingdom.army[unitType] * UNIT_STATS[unitType].upkeep;
            }
            return Math.floor(totalUpkeep * gameState.upkeepModifier);
        }
        function areKingdomsAdjacent(kingdomId1, kingdomId2) {
            if (!kingdomId1 || !kingdomId2) return false;
            const kingdom1Regions = Object.values(gameState.regions).filter(r => r.owner === kingdomId1);
            for (const region of kingdom1Regions) {
                const neighbors = REGION_ADJACENCY[region.id] || [];
                for (const neighborId of neighbors) {
                    if (gameState.regions[neighborId] && gameState.regions[neighborId].owner === kingdomId2) {
                        return true;
                    }
                }
            }
            return false;
        }

    const barracksModal = document.getElementById('barracks-modal');
    document.getElementById('barracks-btn').addEventListener('click', () => {
        sfxBarracks.play();
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.getElementById('modal-recruitable-pop').textContent = player.recruitablePop;
        document.getElementById('modal-current-gold').textContent = player.gold;
        document.getElementById('recruit-infantry-slider').value = 0;
        document.getElementById('recruit-archer-slider').value = 0;
        document.getElementById('recruit-cavalry-slider').value = 0;
        updateRecruitSliders();
        barracksModal.style.display = 'block';
    });
    document.getElementById('close-barracks-btn').addEventListener('click', () => barracksModal.style.display = 'none');
    document.getElementById('recruit-sliders').addEventListener('input', updateRecruitSliders);

    function updateRecruitSliders() {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const sliders = { infantry: document.getElementById('recruit-infantry-slider'), archer: document.getElementById('recruit-archer-slider'), cavalry: document.getElementById('recruit-cavalry-slider') };
        const values = { infantry: parseInt(sliders.infantry.value), archer: parseInt(sliders.archer.value), cavalry: parseInt(sliders.cavalry.value) };
        let totalCost = (values.infantry * UNIT_STATS.infantry.price) + (values.archer * UNIT_STATS.archer.price) + (values.cavalry * UNIT_STATS.cavalry.price);
        let totalPop = values.infantry + values.archer + values.cavalry;
        while (totalCost > player.gold || totalPop > player.recruitablePop) {
            if (values.cavalry > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.cavalry--; }
            else if (values.archer > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.archer--; }
            else if (values.infantry > 0 && (totalCost > player.gold || totalPop > player.recruitablePop)) { values.infantry--; }
            else { break; }
            totalCost = (values.infantry * UNIT_STATS.infantry.price) + (values.archer * UNIT_STATS.archer.price) + (values.cavalry * UNIT_STATS.cavalry.price);
            totalPop = values.infantry + values.archer + values.cavalry;
        }
        sliders.infantry.value = values.infantry; sliders.archer.value = values.archer; sliders.cavalry.value = values.cavalry;
        document.getElementById('recruit-infantry-value').textContent = values.infantry;
        document.getElementById('recruit-archer-value').textContent = values.archer;
        document.getElementById('recruit-cavalry-value').textContent = values.cavalry;
        sliders.infantry.max = values.infantry + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.infantry.price));
        sliders.archer.max = values.archer + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.archer.price));
        sliders.cavalry.max = values.cavalry + Math.min(player.recruitablePop - totalPop, Math.floor((player.gold - totalCost) / UNIT_STATS.cavalry.price));
        document.getElementById('total-recruit-cost').textContent = totalCost;
        document.getElementById('total-recruit-pop').textContent = totalPop;
    }

    document.getElementById('confirm-recruit-btn').addEventListener('click', () => {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const inf = parseInt(document.getElementById('recruit-infantry-slider').value), arc = parseInt(document.getElementById('recruit-archer-slider').value), cav = parseInt(document.getElementById('recruit-cavalry-slider').value);
        const cost = (inf * UNIT_STATS.infantry.price) + (arc * UNIT_STATS.archer.price) + (cav * UNIT_STATS.cavalry.price), pop = inf + arc + cav;
        if(pop === 0) return; player.gold -= cost; player.recruitablePop -= pop;
        player.army.infantry += inf; player.army.archer += arc; player.army.cavalry += cav;
        addMessage(`Tur ${gameState.turn}: Orduya yeni askerler katıldı.`, "success");
        barracksModal.style.display = 'none'; updateUI();
    });

    const taxModal = document.getElementById('tax-modal');
    document.getElementById('tax-btn').addEventListener('click', () => {
        sfxTax.play();
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.getElementById('tax-rate-slider').value = player.taxRate;
        updateTaxModalDetails(player);

        const penaltyInfo = document.getElementById('tax-penalty-info');
        const taxControls = document.getElementById('tax-controls');
        const confirmBtn = document.getElementById('confirm-tax-btn');

        if (gameState.taxPenaltyTurns > 0) {
            penaltyInfo.textContent = `İsyan nedeniyle vergiler kilitlendi. Ceza bitimine: ${gameState.taxPenaltyTurns} tur`;
            penaltyInfo.style.display = 'block';
            taxControls.style.display = 'none';
            confirmBtn.style.display = 'none';
        } else {
            penaltyInfo.style.display = 'none';
            taxControls.style.display = 'block';
            confirmBtn.style.display = 'inline-block';
        }

        taxModal.style.display = 'block';
    });
    document.getElementById('tax-rate-slider').addEventListener('input', (e) => { const tempPlayer = {...gameState.kingdoms[PLAYER_KINGDOM_ID], taxRate: parseInt(e.target.value) }; updateTaxModalDetails(tempPlayer); });
    function updateTaxModalDetails(kingdom) {
        document.getElementById('tax-rate-value').textContent = kingdom.taxRate;
        document.getElementById('modal-income').textContent = calculateIncome(kingdom);
        document.getElementById('modal-upkeep').textContent = calculateUpkeep(kingdom);

        let risk = "Çok Düşük";
        const taxWarning = document.getElementById('tax-warning');
        taxWarning.style.display = 'none';

        if (kingdom.taxRate > 40) {
            risk = "Çok Yüksek!";
            taxWarning.textContent = "AŞIRI YÜKSEK VERGİ! Halk isyanın eşiğinde!";
            taxWarning.style.display = 'block';
        } else if (kingdom.taxRate > 30) {
            risk = "Yüksek";
            taxWarning.textContent = "Yüksek vergiler halkı ciddi şekilde mutsuz ediyor.";
            taxWarning.style.display = 'block';
        } else if (kingdom.taxRate > 20) {
            risk = "Orta";
        } else if (kingdom.taxRate > 10) {
            risk = "Düşük";
        }
        document.getElementById('rebellion-risk').textContent = risk;
    }
    document.getElementById('close-tax-btn').addEventListener('click', () => taxModal.style.display = 'none');
    document.getElementById('confirm-tax-btn').addEventListener('click', () => {
        gameState.kingdoms[PLAYER_KINGDOM_ID].taxRate = parseInt(document.getElementById('tax-rate-slider').value);
        addMessage(`Tur ${gameState.turn}: Vergi oranı güncellendi.`, "success");
        taxModal.style.display = 'none'; updateUI();
    });

    const battleModal = document.getElementById('battle-modal');
    const defenseModal = document.getElementById('defense-modal');
    document.getElementById('close-battle-modal-btn').addEventListener('click', () => battleModal.style.display = 'none');

    document.getElementById('attack-btn').addEventListener('click', () => {
        if (gameState.playerAttackedThisTurn) { addMessage("Bu tur zaten bir savaş başlattınız.", "error"); return; }
        const targetRegion = gameState.regions[gameState.selectedRegionId];
        if (!targetRegion || targetRegion.owner === PLAYER_KINGDOM_ID || !targetRegion.owner) { addMessage("Savaş açmak için bir düşman bölgesi seçin.", "error"); return; }

        if (targetRegion.owner === REBELS_ID) {
             gameState.activeBattle = { attackerId: PLAYER_KINGDOM_ID, defenderId: REBELS_ID, targetRegionId: targetRegion.id, playerRole: 'attacker' };
        } else {
             gameState.activeBattle = { attackerId: PLAYER_KINGDOM_ID, defenderId: targetRegion.owner, targetRegionId: targetRegion.id, playerRole: 'attacker' };
        }

        sfxAttack.play();
        openBattleModal();
    });

    function openBattleModal() {
        const defenderKingdomInfo = KINGDOM_DETAILS[gameState.activeBattle.defenderId];
        document.getElementById('battle-modal-title').textContent = `${defenderKingdomInfo.name} Krallığına Savaş Planı`;
        const grid = document.getElementById('battle-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            grid.innerHTML += `<div class="battle-tile" data-tile-id="${i}"><h5>Bölge ${i + 1}</h5>
                <div class="slider-container"><label>🚶<span data-unit-value="infantry">0</span></label><input type="range" min="0" value="0" data-unit="infantry" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="slider-container"><label>🏹<span data-unit-value="archer">0</span></label><input type="range" min="0" value="0" data-unit="archer" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="slider-container"><label>🐎<span data-unit-value="cavalry">0</span></label><input type="range" min="0" value="0" data-unit="cavalry" oninput="updateAllocationSliders('battle-grid')"></div>
                <div class="tile-power">Güç: 0</div></div>`;
        }
        updateAllocationSliders('battle-grid');
        battleModal.style.display = 'block';
    }

    function openDefenseModal() {
        sfxDefenseAlert.play();
        const attackerKingdomInfo = KINGDOM_DETAILS[gameState.activeBattle.attackerId];
        document.getElementById('defense-modal-title').textContent = `${attackerKingdomInfo.name} Saldırısına Karşı Savunma Planı`;
        const grid = document.getElementById('defense-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            grid.innerHTML += `<div class="battle-tile" data-tile-id="${i}"><h5>Bölge ${i + 1}</h5>
                <div class="slider-container"><label>🚶<span data-unit-value="infantry">0</span></label><input type="range" min="0" value="0" data-unit="infantry" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="slider-container"><label>🏹<span data-unit-value="archer">0</span></label><input type="range" min="0" value="0" data-unit="archer" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="slider-container"><label>🐎<span data-unit-value="cavalry">0</span></label><input type="range" min="0" value="0" data-unit="cavalry" oninput="updateAllocationSliders('defense-grid')"></div>
                <div class="tile-power">Güç: 0</div></div>`;
        }
        updateAllocationSliders('defense-grid');
        defenseModal.style.display = 'block';
    }

    function updateAllocationSliders(gridId) {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        const availableArmy = {...player.army};
        const sliders = { infantry: [], archer: [], cavalry: [] };
        let totalAllocated = { infantry: 0, archer: 0, cavalry: 0 };

        document.querySelectorAll(`#${gridId} input[type="range"]`).forEach(slider => sliders[slider.dataset.unit].push(slider));
        Object.keys(sliders).forEach(unitType => { totalAllocated[unitType] = sliders[unitType].reduce((sum, s) => sum + parseInt(s.value), 0); });
        Object.keys(sliders).forEach(unitType => {
            sliders[unitType].forEach(slider => {
                const currentVal = parseInt(slider.value);
                const allocatedElsewhere = totalAllocated[unitType] - currentVal;
                slider.max = availableArmy[unitType] - allocatedElsewhere;
                slider.parentElement.querySelector('span').textContent = currentVal;
                let power = 0;
                slider.closest('.battle-tile').querySelectorAll('input[type="range"]').forEach(s => { power += parseInt(s.value) * UNIT_STATS[s.dataset.unit].power; });
                slider.closest('.battle-tile').querySelector('.tile-power').textContent = `Güç: ${power.toFixed(2)}`;
            });
        });
        const displayPrefix = gridId === 'battle-grid' ? 'available' : 'garrison';
        document.getElementById(`${displayPrefix}-infantry`).textContent = availableArmy.infantry - totalAllocated.infantry;
        document.getElementById(`${displayPrefix}-archer`).textContent = availableArmy.archer - totalAllocated.archer;
        document.getElementById(`${displayPrefix}-cavalry`).textContent = availableArmy.cavalry - totalAllocated.cavalry;
    }

    function getPlayerAllocation(gridId) {
        let allocation = {}, totalAllocated = { infantry: 0, archer: 0, cavalry: 0 };
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        document.querySelectorAll(`#${gridId} .battle-tile`).forEach(tile => {
            const tileId = tile.dataset.tileId;
            const inf = parseInt(tile.querySelector('[data-unit="infantry"]').value);
            const arc = parseInt(tile.querySelector('[data-unit="archer"]').value);
            const cav = parseInt(tile.querySelector('[data-unit="cavalry"]').value);
            allocation[tileId] = { infantry: inf, archer: arc, cavalry: cav };
            totalAllocated.infantry += inf; totalAllocated.archer += arc; totalAllocated.cavalry += cav;
        });
        if (totalAllocated.infantry > player.army.infantry || totalAllocated.archer > player.army.archer || totalAllocated.cavalry > player.army.cavalry) {
            addMessage("Sahip olduğunuzdan fazla asker yerleştiremezsiniz!", "error"); return null;
        }
        return allocation;
    }

    function aiDistributeTroops(army) {
        let allocation = {}, armyPool = {...army};
        for (let i = 0; i < 4; i++) { allocation[i] = { infantry: 0, archer: 0, cavalry: 0 }; }
        Object.keys(armyPool).forEach(unitType => {
            let unitsToAllocate = armyPool[unitType];
            while (unitsToAllocate > 0) {
                const targetTile = Math.floor(Math.random() * 4);
                const amount = Math.min(unitsToAllocate, Math.ceil(Math.random() * unitsToAllocate * 0.8) + 1);
                allocation[targetTile][unitType] += amount;
                unitsToAllocate -= amount;
            }
        });
        return allocation;
    }

    document.getElementById('confirm-battle-plan-btn').addEventListener('click', () => {
        const battle = gameState.activeBattle;
        battle.attackerAllocation = getPlayerAllocation('battle-grid');
        if (!battle.attackerAllocation) return;

        const defenderId = battle.defenderId;
        const defendingRegion = gameState.regions[battle.targetRegionId];
        let defendingArmy;

        if (defenderId === REBELS_ID) {
            defendingArmy = { infantry: defendingRegion.infantry, archer: 0, cavalry: 0 };
        } else {
            const defender = gameState.kingdoms[defenderId];
            defendingArmy = {...defender.army};
            if (!defendingRegion.isKingdomCapital) {
                Object.keys(defendingArmy).forEach(key => defendingArmy[key] = Math.floor(defendingArmy[key] * 0.4));
            }
        }
        battle.defenderAllocation = aiDistributeTroops(defendingArmy);
        resolveBattle();
        battleModal.style.display = 'none';
    });

     document.getElementById('confirm-defense-plan-btn').addEventListener('click', () => {
        gameState.activeBattle.defenderAllocation = getPlayerAllocation('defense-grid');
        if (!gameState.activeBattle.defenderAllocation) return;
        resolveBattle();
        defenseModal.style.display = 'none';
        finishTurn();
    });

    function resolveBattle() {
        const battle = gameState.activeBattle;
        const attacker = gameState.kingdoms[battle.attackerId];
        const defender = battle.defenderId === REBELS_ID ? null : gameState.kingdoms[battle.defenderId];

        let attackerTilesWon = 0;
        for (let i = 0; i < 4; i++) {
            const attTile = battle.attackerAllocation[i];
            const defTile = battle.defenderAllocation[i];
            const attPower = (attTile.infantry * UNIT_STATS.infantry.power) + (attTile.archer * UNIT_STATS.archer.power) + (attTile.cavalry * UNIT_STATS.cavalry.power);
            const defPower = (defTile.infantry * UNIT_STATS.infantry.power) + (defTile.archer * UNIT_STATS.archer.power) + (defTile.cavalry * UNIT_STATS.cavalry.power);

            if (attPower > defPower) {
                attackerTilesWon++;
                if(defender) {
                    defender.army.infantry -= defTile.infantry; defender.army.archer -= defTile.archer; defender.army.cavalry -= defTile.cavalry;
                }
                if(attacker) { // Attacker might be rebels with no central army
                     attacker.army.infantry -= Math.floor(attTile.infantry * 0.3); attacker.army.archer -= Math.floor(attTile.archer * 0.3); attacker.army.cavalry -= Math.floor(attTile.cavalry * 0.3);
                }
            } else {
                if(attacker) {
                    attacker.army.infantry -= attTile.infantry; attacker.army.archer -= attTile.archer; attacker.army.cavalry -= attTile.cavalry;
                }
                if (defender) {
                    defender.army.infantry -= Math.floor(defTile.infantry * 0.3); defender.army.archer -= Math.floor(defTile.archer * 0.3); defender.army.cavalry -= Math.floor(defTile.cavalry * 0.3);
                }
            }
        }
        if(attacker) Object.keys(attacker.army).forEach(k => attacker.army[k] = Math.max(0, attacker.army[k]));
        if(defender) Object.keys(defender.army).forEach(k => defender.army[k] = Math.max(0, defender.army[k]));

        if (attackerTilesWon >= 3) {
            addMessage(`Tur ${gameState.turn}: ${KINGDOM_DETAILS[battle.attackerId].name}, ${KINGDOM_DETAILS[battle.defenderId].name}'a ait ${gameState.regions[battle.targetRegionId].name} bölgesini fethetti!`, "battle_win");
            gameState.regions[battle.targetRegionId].owner = battle.attackerId;
            gameState.regions[battle.targetRegionId].infantry = 0;
            if(battle.attackerId === PLAYER_KINGDOM_ID) gameState.kingdoms[PLAYER_KINGDOM_ID].lastExpansionTurn = gameState.turn;

            if (battle.attackerId === PLAYER_KINGDOM_ID) sfxVictory.play();
            else if (battle.defenderId === PLAYER_KINGDOM_ID) sfxDefeat.play();

        } else {
            addMessage(`Tur ${gameState.turn}: ${KINGDOM_DETAILS[battle.attackerId].name} saldırısı, ${KINGDOM_DETAILS[battle.defenderId].name} tarafından püskürtüldü!`, "battle_lose");

            if (battle.isRebellion) {
                 gameState.regions[battle.targetRegionId].owner = REBELS_ID;
                 gameState.regions[battle.targetRegionId].infantry = 100;
            }

            if (battle.attackerId === PLAYER_KINGDOM_ID) sfxDefeat.play();
            else if (battle.defenderId === PLAYER_KINGDOM_ID) sfxVictory.play();
        }
        gameState.activeBattle = null;
        if (battle.attackerId === PLAYER_KINGDOM_ID) gameState.playerAttackedThisTurn = true;
        updateUI();
    }

    document.getElementById('next-turn-btn').addEventListener('click', startTurn);

    function startTurn(){
        const nextTurnBtn = document.getElementById('next-turn-btn');
        if (nextTurnBtn.disabled) return;
        nextTurnBtn.disabled = true;

        let continueTurn = processAiTurns();
        if(continueTurn) {
            finishTurn();
        }
    }

    function processAiTurns() {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        for (const kId in gameState.kingdoms) {
            const kingdom = gameState.kingdoms[kId];
            if (kingdom.aiControlled && !kingdom.isRebel && kId !== player.id) {
                if(areKingdomsAdjacent(kId, PLAYER_KINGDOM_ID)) {
                    let aggressionChance = 0.05;
                    if (kingdom.population > player.population * 1.2) aggressionChance += 0.1;
                    if (gameState.turn - player.lastExpansionTurn > 25) aggressionChance += 0.2;
                    if (Math.random() < aggressionChance) {
                        const targetablePlayerRegions = Object.values(gameState.regions).filter(r => r.owner === PLAYER_KINGDOM_ID && (REGION_ADJACENCY[r.id] || []).some(nId => gameState.regions[nId]?.owner === kId));
                        if(targetablePlayerRegions.length > 0) {
                            const targetRegion = targetablePlayerRegions[Math.floor(Math.random() * targetablePlayerRegions.length)];
                            gameState.activeBattle = { attackerId: kId, defenderId: PLAYER_KINGDOM_ID, targetRegionId: targetRegion.id, playerRole: 'defender', attackerAllocation: aiDistributeTroops(kingdom.army), defenderAllocation: {} };
                            openDefenseModal();
                            return false;
                        }
                    }
                }
            }
        }
        return true;
    }
    
    const economicEventModal = document.getElementById('economic-event-modal');
    const closeEconomicEventBtn = document.getElementById('close-economic-event-btn');
    closeEconomicEventBtn.addEventListener('click', () => {
        economicEventModal.style.display = 'none';
        finishTurnAfterEvent();
    });

    function triggerEconomicEvent() {
        const availableEvents = economicEvents.filter(e => !triggeredEconomicEvents.includes(e.id));
        if (availableEvents.length === 0) {
            finishTurnAfterEvent();
            return;
        }

        const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
        triggeredEconomicEvents.push(event.id);
        
        event.apply(gameState.kingdoms[PLAYER_KINGDOM_ID]);

        document.getElementById('economic-event-title').textContent = event.title;
        document.getElementById('economic-event-text').textContent = event.text;
        economicEventModal.style.display = 'block';

        gameState.nextEconomicEventTurn = gameState.turn + Math.floor(Math.random() * 5) + 5;
    }


    function finishTurn() {
        if (gameState.activeBattle) return;
        
        if (gameState.turn === gameState.nextEconomicEventTurn) {
            triggerEconomicEvent();
            return; // Pause the turn until the user closes the event modal
        }
        
        finishTurnAfterEvent();
    }

    function finishTurnAfterEvent() {
        gameState.turn++;
        gameState.playerAttackedThisTurn = false;
        if (gameState.turn > 1 && gameState.turn % 20 === 0) { gameState.upkeepModifier += 0.05; addMessage(`Tur ${gameState.turn}: Artan krallık masrafları nedeniyle asker bakım maliyetleri %5 arttı!`, "info"); }

        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];

        if (gameState.taxPenaltyTurns > 0) {
            gameState.taxPenaltyTurns--;
        }

        for (const kId in gameState.kingdoms) {
            const kingdom = gameState.kingdoms[kId];
            if(!kingdom) continue;
            kingdom.gold += calculateIncome(kingdom);
            kingdom.gold -= calculateUpkeep(kingdom);
             if (kId === PLAYER_KINGDOM_ID && kingdom.gold < 0) {
                const disbandedTroops = Math.min(kingdom.army.infantry, Math.ceil(Math.abs(kingdom.gold) / UNIT_STATS.infantry.upkeep / gameState.upkeepModifier));
                if (disbandedTroops > 0) {
                    kingdom.army.infantry -= disbandedTroops;
                    kingdom.gold = 0;
                    addMessage(`Tur ${gameState.turn}: Hazine boşaldığı için ${disbandedTroops} piyade terhis edildi!`, 'error');
                }
            }
        }

        if (player.taxRate > 30 && gameState.taxPenaltyTurns <= 0 && Math.random() < ((player.taxRate - 30) / 100)) {
            const potentialRebelRegions = Object.values(gameState.regions).filter(r => r.owner === PLAYER_KINGDOM_ID && !r.isKingdomCapital);
            if (potentialRebelRegions.length > 0) {
                const rebelRegion = potentialRebelRegions[Math.floor(Math.random() * potentialRebelRegions.length)];
                addMessage(`Tur ${gameState.turn}: ${rebelRegion.name} bölgesinde yüksek vergiler nedeniyle isyan çıktı!`, "rebellion");

                player.taxRate = 5;
                gameState.taxPenaltyTurns = 4;

                if (!gameState.kingdoms[REBELS_ID]) {
                    const details = KINGDOM_DETAILS[REBELS_ID];
                    gameState.kingdoms[REBELS_ID] = { id: REBELS_ID, name: details.name, isPlayer: false, aiControlled: true, gold: 0, population: 0, army: { infantry: 0, archer: 0, cavalry: 0 }};
                }

                rebelRegion.owner = REBELS_ID;
                rebelRegion.infantry = 100 + Math.floor(Math.random() * 50);
                
                addMessage(`Tur ${gameState.turn}: ${rebelRegion.name} isyancıların eline geçti!`);
            }
        }
        
        Object.values(gameState.kingdoms).forEach(k => {
            if(k.isPlayer) {
                 const growth = Math.floor(k.population * 0.01 * (k.happiness / 100));
                 k.population += growth;
                 k.recruitablePop += Math.floor(growth * 0.1);
            }
        });
        

        addMessage(`Tur ${gameState.turn} sona erdi.`, "info");
        updateUI();
        const isGameOver = checkGameEndConditions();
        if (!isGameOver) document.getElementById('next-turn-btn').disabled = false;
    }

    function checkGameEndConditions() {
        const player = gameState.kingdoms[PLAYER_KINGDOM_ID];
        let playerOwnedRegionCount = 0, isGameOver = false;
        for (const regionId in gameState.regions) { if (gameState.regions[regionId].owner === PLAYER_KINGDOM_ID) playerOwnedRegionCount++; }
        
        const playerCapital = gameState.regions[player.mainRegionId];
        const playerCapitalStillOwned = playerCapital && playerCapital.owner === PLAYER_KINGDOM_ID;

        if (playerOwnedRegionCount === 0 || !playerCapitalStillOwned) {
            document.getElementById('game-over-modal').style.display = 'block';
            isGameOver = true;
        }
        if (isGameOver) document.getElementById('next-turn-btn').disabled = true;
        return isGameOver;
    }

    initializeOrLoadGame();
</script>
</body>
</html>